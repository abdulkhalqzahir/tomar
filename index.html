<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نەخشەی 3Dی کۆلێژ - زانکۆی سەڵاحەدین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: pan-x pan-y;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, 'Noto Sans Arabic', sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 50%, #6b3e2a 100%);
            color: white;
            min-height: 100vh;
            direction: rtl;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, rgba(44, 24, 16, 0.95), rgba(74, 44, 26, 0.95));
            backdrop-filter: blur(15px);
            border-bottom: 3px solid #d4a574;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #d4a574, #b8935f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c1810;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 0 15px rgba(212, 165, 116, 0.5);
        }

        .title {
            flex: 1;
            margin-right: 12px;
        }

        .title h1 {
            font-size: 18px;
            margin-bottom: 2px;
            color: #f4e4d4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .title h2 {
            font-size: 14px;
            color: #d4a574;
            font-weight: 600;
        }

        .location-indicator {
            background: rgba(212, 165, 116, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            border: 1px solid rgba(212, 165, 116, 0.4);
        }

        /* Main Content */
        .main-container {
            position: fixed;
            top: 70px;
            bottom: 80px;
            left: 0;
            right: 0;
            width: 100%;
        }

        #3d-viewer {
            width: 100%;
            height: 100%;
            display: block;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 50%, #8B7355 100%);
        }

        /* Navigation Overlay */
        .navigation-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: linear-gradient(135deg, rgba(44, 24, 16, 0.9), rgba(74, 44, 26, 0.9));
            border-radius: 15px;
            padding: 15px;
            z-index: 500;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(212, 165, 116, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .nav-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-room {
            font-weight: bold;
            font-size: 18px;
            color: #d4a574;
        }

        .room-floor {
            background: rgba(212, 165, 116, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #d4a574;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #8B7355, #d4a574);
            border-radius: 10px;
            width: 5%;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(244, 228, 212, 0.8);
        }

        /* User Position Indicator */
        .user-position {
            position: absolute;
            width: 40px;
            height: 40px;
            z-index: 400;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .user-dot {
            width: 24px;
            height: 24px;
            background: #FFD700;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            left: 8px;
            box-shadow: 0 0 20px #FFD700, 0 0 40px rgba(255, 215, 0, 0.5);
            animation: pulse 2s infinite;
        }

        .user-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid #FFD700;
            position: absolute;
            top: -5px;
            left: 12px;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 15px;
            left: 15px;
            right: 15px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(44, 24, 16, 0.95), rgba(74, 44, 26, 0.95));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 0 20px;
            z-index: 1000;
            border: 2px solid rgba(212, 165, 116, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8B7355, #6b5637);
            border: 2px solid rgba(212, 165, 116, 0.3);
            color: #f4e4d4;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: scale(0.9);
            background: linear-gradient(135deg, #d4a574, #b8935f);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #d4a574, #b8935f);
            color: #2c1810;
        }

        /* Room Info Panel */
        .room-info-panel {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(44, 24, 16, 0.98), rgba(74, 44, 26, 0.98));
            backdrop-filter: blur(20px);
            border-radius: 25px 25px 0 0;
            padding: 25px 20px;
            z-index: 1500;
            transition: bottom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.6);
            border-top: 3px solid #d4a574;
            max-height: 70vh;
            overflow-y: auto;
        }

        .room-info-panel.open {
            bottom: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(212, 165, 116, 0.2);
        }

        .panel-title {
            font-size: 22px;
            color: #d4a574;
            font-weight: bold;
        }

        .close-panel {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(212, 165, 116, 0.1);
            border: none;
            color: #f4e4d4;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .room-details {
            margin-bottom: 25px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(212, 165, 116, 0.05);
            border-radius: 10px;
            border-right: 3px solid #d4a574;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 18px;
            color: #d4a574;
        }

        .detail-text {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: rgba(244, 228, 212, 0.6);
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #f4e4d4;
        }

        .direction-info {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .direction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .direction-text {
            font-size: 14px;
            line-height: 1.5;
            color: #f4e4d4;
        }

        /* Touch Controls */
        .touch-controls {
            position: absolute;
            bottom: 90px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 300;
        }

        .joystick {
            position: absolute;
            width: 70px;
            height: 70px;
            background: rgba(44, 24, 16, 0.7);
            border-radius: 50%;
            border: 2px solid rgba(212, 165, 116, 0.3);
            top: 25px;
            left: 25px;
        }

        .joystick-handle {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(212, 165, 116, 0.8);
            border-radius: 50%;
            top: 15px;
            left: 15px;
            transition: transform 0.1s;
        }

        .touch-buttons {
            position: absolute;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(44, 24, 16, 0.7);
            border: 2px solid rgba(212, 165, 116, 0.3);
            color: #f4e4d4;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Permission Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #4a2c1a);
            border-radius: 25px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 3px solid #d4a574;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .modal-icon {
            font-size: 60px;
            color: #d4a574;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            color: #f4e4d4;
            margin-bottom: 15px;
        }

        .modal-text {
            color: rgba(244, 228, 212, 0.8);
            line-height: 1.6;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.allow {
            background: linear-gradient(to right, #8B7355, #d4a574);
            color: #2c1810;
        }

        .modal-btn.deny {
            background: rgba(244, 228, 212, 0.1);
            color: #f4e4d4;
            border: 2px solid rgba(244, 228, 212, 0.3);
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(44, 24, 16, 0.95), rgba(74, 44, 26, 0.95));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            transform: translateY(-100px);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(212, 165, 116, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast-icon {
            font-size: 24px;
            color: #d4a574;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #f4e4d4;
        }

        .toast-text {
            font-size: 14px;
            color: rgba(244, 228, 212, 0.8);
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .mobile-header {
                height: 60px;
            }
            
            .logo {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .title h1 {
                font-size: 16px;
            }
            
            .title h2 {
                font-size: 12px;
            }
            
            .navigation-overlay {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
            }
            
            .mobile-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                height: 55px;
                padding: 0 15px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .room-info-panel {
                padding: 20px 15px;
            }
        }

        /* Hide scrollbars but keep functionality */
        .room-info-panel::-webkit-scrollbar {
            width: 5px;
        }
        
        .room-info-panel::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.5);
            border-radius: 10px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c1810, #4a2c1a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-icon {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(212, 165, 116, 0.2);
            border-top: 4px solid #d4a574;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #d4a574;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon"></div>
        <div class="loading-text">دەستپێکردنی نەخشە...</div>
    </div>

    <!-- Permission Modal -->
    <div class="permission-modal" id="permissionModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2 class="modal-title">بەخێربێیت بۆ نەخشەی 3Dی کۆلێژ!</h2>
            <p class="modal-text">بۆ ئەوەی بتوانین شوێنی ڕاستەقینەت نیشان بدەین و ڕێنمایی بکەین بۆ هۆڵەکان، پێویستە ڕێگە بدەیت بە بەکارهێنانی لۆکەیشن.</p>
            <div class="modal-buttons">
                <button class="modal-btn allow" id="allowLocation">
                    <i class="fas fa-check-circle"></i> ڕێگەدان بە لۆکەیشن
                </button>
                <button class="modal-btn deny" id="denyLocation">
                    <i class="fas fa-times-circle"></i> بەبێ لۆکەیشن بەردەوام بە
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">سەلام</div>
            <div class="toast-text" id="toastText">بەخێربێیت بۆ نەخشەی کۆلێژ</div>
        </div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="header-content">
            <div class="logo">س</div>
            <div class="title">
                <h1>زانکۆی سەڵاحەدین</h1>
                <h2>نەخشەی 3Dی کۆلێژ</h2>
            </div>
            <div class="location-indicator" id="locationStatus">
                <i class="fas fa-map-marker-alt"></i>
                <span>لۆکەیشن...</span>
            </div>
        </div>
    </div>

    <!-- Main 3D Viewer -->
    <div class="main-container">
        <canvas id="3d-viewer"></canvas>
        
        <!-- Navigation Overlay -->
        <div class="navigation-overlay">
            <div class="nav-info">
                <div class="current-room" id="currentRoomName">دەرگای سەرەکی</div>
                <div class="room-floor" id="currentRoomFloor">نهۆمی سەرەتایی</div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="tourProgress"></div>
            </div>
            <div class="progress-text">
                <span>پێشکەوتن</span>
                <span id="progressPercent">5%</span>
            </div>
        </div>

        <!-- User Position Indicator -->
        <div class="user-position" id="userPosition" style="display: none;">
            <div class="user-arrow"></div>
            <div class="user-dot"></div>
        </div>

        <!-- Touch Controls -->
        <div class="touch-controls" id="touchControls">
            <div class="joystick">
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>
        </div>

        <div class="touch-buttons">
            <div class="touch-btn" id="zoomInBtn">
                <i class="fas fa-plus"></i>
            </div>
            <div class="touch-btn" id="zoomOutBtn">
                <i class="fas fa-minus"></i>
            </div>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <button class="control-btn" id="prevRoomBtn">
            <i class="fas fa-arrow-right"></i>
        </button>
        <button class="control-btn active" id="autoTourBtn">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" id="infoBtn">
            <i class="fas fa-info"></i>
        </button>
        <button class="control-btn" id="nextRoomBtn">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Room Info Panel -->
    <div class="room-info-panel" id="roomInfoPanel">
        <div class="panel-header">
            <div class="panel-title">زانیاری هۆڵ</div>
            <button class="close-panel" id="closePanelBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="room-details" id="roomDetails">
            <!-- Room details will be loaded here -->
        </div>
        
        <div class="direction-info" id="directionInfo">
            <div class="direction-header">
                <i class="fas fa-directions"></i>
                <h3>ڕێنمایی بۆ ئەم هۆڵە</h3>
            </div>
            <p class="direction-text" id="directionText">لە شوێنی ئێستا، بە ڕاست بڕۆ بۆ گەیشتن بەم هۆڵە...</p>
        </div>
    </div>

    <script>
        // Room data with detailed information
        const rooms = [
            { 
                id: 1, 
                name: "دەرگای سەرەکی", 
                floor: "ground", 
                x: 0, y: 0, z: 15,
                details: "دەرگای سەرەکی چوونە ناو کۆلێژەوە",
                description: "دەرگای سەرەکی کۆلێژ کە بۆ هەموو خوێندکاران و مامۆستایان کراوەیە",
                distance: 0,
                visited: true,
                current: true
            },
            { 
                id: 2, 
                name: "ئەکاونتی", 
                floor: "first", 
                x: -5, y: 3, z: 10,
                details: "بەشی ئەکاونتی - نهۆمی یەکەم",
                description: "بەشی خوێندنی ئەکاونتی و هەموو وانەکانی تێدایە",
                distance: 15
            },
            { 
                id: 3, 
                name: "ئابووری", 
                floor: "first", 
                x: 5, y: 3, z: 10,
                details: "بەشی ئابووری - نهۆمی یەکەم",
                description: "بەشی ئابووری و ئابووری نێودەوڵەتی",
                distance: 18
            },
            { 
                id: 4, 
                name: "کتێبخانە", 
                floor: "ground", 
                x: -8, y: 0, z: 5,
                details: "کتێبخانەی کۆلێژ",
                description: "کتێبخانەی سەرەکی کۆلێژ بە هەزاران کتێب و سەرچاوە",
                distance: 12
            },
            { 
                id: 5, 
                name: "موسڵمانان", 
                floor: "ground", 
                x: 10, y: 0, z: 0,
                details: "موسڵمانی نێرینە",
                description: "موسڵمانی کۆلێژ بۆ نوێژ و عیبادەت",
                distance: 20
            },
            { 
                id: 6, 
                name: "تەوالێت", 
                floor: "ground", 
                x: 12, y: 0, z: -5,
                details: "تەوالێتی نێرینە",
                description: "تەوالێتی پاک و ئاسایی",
                distance: 22
            },
            { 
                id: 7, 
                name: "تەوالێتی مێینە", 
                floor: "ground", 
                x: -12, y: 0, z: -5,
                details: "تەوالێتی مێینە",
                description: "تەوالێتی تایبەت بە خوێندکارە مێینەکان",
                distance: 25
            },
            { 
                id: 8, 
                name: "وەرگرتنی خوێندکار", 
                floor: "ground", 
                x: -5, y: 0, z: -10,
                details: "بەشی وەرگرتنی خوێندکارە نوێیەکان",
                description: "بەشی وەرگرتنی خوێندکارانی نوێ و یارمەتیدانیان",
                distance: 18
            },
            { 
                id: 9, 
                name: "ئامادەبوون", 
                floor: "ground", 
                x: 5, y: 0, z: -10,
                details: "ئامادەبوونی خوێندکاران",
                description: "خشتەی ئامادەبوونی خوێندکاران و تۆمارکردن",
                distance: 16
            },
            { 
                id: 10, 
                name: "پارێزەر", 
                floor: "ground", 
                x: 15, y: 0, z: 8,
                details: "پارێزەری کۆلێژ",
                description: "ژووری پارێزەر و پاراستنی کۆلێژ",
                distance: 25
            },
            { 
                id: 11, 
                name: "پێشوازیکردن", 
                floor: "ground", 
                x: 0, y: 0, z: 12,
                details: "ژووری پێشوازیکردن",
                description: "ژووری پێشوازیکردن و یارمەتیدانی سەردانکەران",
                distance: 8
            },
            { 
                id: 12, 
                name: "چاپ", 
                floor: "ground", 
                x: -15, y: 0, z: 8,
                details: "بەشی چاپکردن",
                description: "بەشی چاپکردنی پەڕە و پڕۆژەکان",
                distance: 28
            },
            { 
                id: 13, 
                name: "کافێ", 
                floor: "ground", 
                x: -10, y: 0, z: -12,
                details: "کافێی کۆلێژ",
                description: "کافێی خوێندکاران بۆ خواردن و خواردنەوە",
                distance: 22
            },
            { 
                id: 14, 
                name: "دوکان", 
                floor: "ground", 
                x: 10, y: 0, z: -12,
                details: "دوکانی کۆلێژ",
                description: "دوکانی کۆلێژ بۆ کاڵای پێویست",
                distance: 20
            },
            { 
                id: 15, 
                name: "وەرزش", 
                floor: "ground", 
                x: 0, y: 0, z: -15,
                details: "بەشی وەرزشی",
                description: "بەشی وەرزش و تەندروستی",
                distance: 18
            },
            { 
                id: 16, 
                name: "مارکێتینگ", 
                floor: "ground", 
                x: -15, y: 0, z: -8,
                details: "بەشی مارکێتینگ",
                description: "بەشی مارکێتینگ و فرۆشتن",
                distance: 30
            },
            { 
                id: 17, 
                name: "ئامار", 
                floor: "second", 
                x: -5, y: 6, z: 10,
                details: "بەشی ئامار - نهۆمی دووەم",
                description: "بەشی ئامار و زانستی داتا",
                distance: 35
            },
            { 
                id: 18, 
                name: "دارایی و بانکداری", 
                floor: "second", 
                x: 5, y: 6, z: 10,
                details: "بەشی دارایی و بانکداری - نهۆمی دووەم",
                description: "بەشی دارایی و بانکداری و بوودجە",
                distance: 38
            },
            { 
                id: 19, 
                name: "دەزگای کۆلێژ", 
                floor: "second", 
                x: 0, y: 6, z: 0,
                details: "دەزگای کۆلێژ - نهۆمی دووەم",
                description: "ژووری دەزگای کۆلێژ و بەڕێوەبردن",
                distance: 42
            },
            { 
                id: 20, 
                name: "یەکەکانی ئەکاونتی", 
                floor: "second", 
                x: -8, y: 6, z: 5,
                details: "یەکەکانی بەشی ئەکاونتی - نهۆمی دووەم",
                description: "یەکەکانی تایبەتی بەشی ئەکاونتی",
                distance: 40
            },
            { 
                id: 21, 
                name: "هۆڵی د. بەیان", 
                floor: "second", 
                x: 8, y: 6, z: 5,
                details: "هۆڵی دکتۆر بەیان - نهۆمی دووەم",
                description: "هۆڵی وانەی گەورە بە ناوی دکتۆر بەیان",
                distance: 38
            },
            { 
                id: 22, 
                name: "هۆڵی شەهید گەرەداغی", 
                floor: "first", 
                x: -10, y: 3, z: -5,
                details: "هۆڵی شەهید گەرەداغی - نهۆمی یەکەم",
                description: "هۆڵی وانەی گەورە بە ناوی شەهید گەرەداغی",
                distance: 28
            },
            { 
                id: 23, 
                name: "هۆڵی ئاشتی", 
                floor: "first", 
                x: 10, y: 3, z: -5,
                details: "هۆڵی ئاشتی - نهۆمی یەکەم",
                description: "هۆڵی وانەی گەورە بە ناوی ئاشتی",
                distance: 26
            },
            { 
                id: 24, 
                name: "یەکێتی خوێندکاران", 
                floor: "first", 
                x: 0, y: 3, z: -5,
                details: "یەکێتی خوێندکاران - نهۆمی یەکەم",
                description: "ژووری یەکێتی خوێندکاران و چالاکیەکان",
                distance: 20
            }
        ];

        // Global variables
        let scene, camera, renderer, controls;
        let roomMeshes = [];
        let currentRoomIndex = 0;
        let isAutoTour = false;
        let tourInterval;
        let userPosition = { x: 0, y: 0, z: 15 };
        let userFloor = "ground";
        let hasLocationPermission = false;
        let visitedRooms = 1;
        let isMoving = false;
        let joystickActive = false;
        let joystickPosition = { x: 0, y: 0 };

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const permissionModal = document.getElementById('permissionModal');
        const allowLocationBtn = document.getElementById('allowLocation');
        const denyLocationBtn = document.getElementById('denyLocation');
        const locationStatus = document.getElementById('locationStatus');
        const currentRoomName = document.getElementById('currentRoomName');
        const currentRoomFloor = document.getElementById('currentRoomFloor');
        const tourProgress = document.getElementById('tourProgress');
        const progressPercent = document.getElementById('progressPercent');
        const userPositionEl = document.getElementById('userPosition');
        const prevRoomBtn = document.getElementById('prevRoomBtn');
        const nextRoomBtn = document.getElementById('nextRoomBtn');
        const autoTourBtn = document.getElementById('autoTourBtn');
        const infoBtn = document.getElementById('infoBtn');
        const roomInfoPanel = document.getElementById('roomInfoPanel');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const roomDetails = document.getElementById('roomDetails');
        const directionText = document.getElementById('directionText');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastText = document.getElementById('toastText');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const joystickHandle = document.getElementById('joystickHandle');
        const touchControls = document.getElementById('touchControls');

        // Initialize the application
        function init() {
            // Setup event listeners first
            setupEventListeners();
            
            // Initialize 3D scene
            init3DScene();
            
            // Hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 1500);
            
            // Show permission modal
            showToast("بەخێربێیت", "نەخشەی 3Dی کۆلێژی بەڕێوەبردن و ئابووری");
            
            // Update UI
            updateUI();
            
            // Start animation loop
            animate();
        }

        // Initialize 3D scene with traditional architecture
        function init3DScene() {
            // Create scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEEB, 10, 100);
            
            // Create camera
            const canvas = document.getElementById('3d-viewer');
            const width = canvas.parentElement.clientWidth;
            const height = canvas.parentElement.clientHeight;
            
            camera = new THREE.PerspectiveCamera(70, width / height, 0.1, 1000);
            camera.position.set(0, 20, 35);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.enablePan = false;
            controls.minDistance = 5;
            controls.maxDistance = 100;
            controls.maxPolarAngle = Math.PI / 2;
            
            // Add enhanced lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 30, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);
            
            // Create traditional building
            createTraditionalBuilding();
            
            // Create rooms
            createRooms();
            
            // Create environment
            createEnvironment();
            
            // Create user position indicator
            createUserIndicator();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Handle touch controls
            setupTouchControls();
        }

        // Create traditional building with old architecture
        function createTraditionalBuilding() {
            // Stone pathway
            const pathwayGeometry = new THREE.BoxGeometry(8, 0.2, 40);
            const pathwayMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8B7355,
                transparent: true,
                opacity: 0.9
            });
            const pathway = new THREE.Mesh(pathwayGeometry, pathwayMaterial);
            pathway.position.y = -0.1;
            pathway.receiveShadow = true;
            scene.add(pathway);
            
            // Create traditional buildings on both sides
            createTraditionalBuildingSide(-15, 0, 0, 'left');
            createTraditionalBuildingSide(15, 0, 0, 'right');
            
            // Ground with traditional texture
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8B7355,
                transparent: true,
                opacity: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        // Create traditional building side
        function createTraditionalBuildingSide(x, y, z, side) {
            // Main building structure
            const buildingGeometry = new THREE.BoxGeometry(8, 12, 30);
            const buildingMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xD2B48C // Tan color for traditional buildings
            });
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
            building.position.set(x, y + 6, z);
            building.castShadow = true;
            building.receiveShadow = true;
            scene.add(building);
            
            // Wooden doors
            for (let i = 0; i < 3; i++) {
                const doorGeometry = new THREE.BoxGeometry(2, 4, 0.5);
                const doorMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x8B4513 // Brown wood color
                });
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                door.position.set(x + (side === 'left' ? 4 : -4), y + 2, z - 8 + i * 8);
                door.castShadow = true;
                scene.add(door);
            }
            
            // Windows with wooden frames
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 2; j++) {
                    const windowGeometry = new THREE.BoxGeometry(1.5, 2, 0.3);
                    const windowMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x87CEEB // Sky blue for windows
                    });
                    const window = new THREE.Mesh(windowGeometry, windowMaterial);
                    window.position.set(
                        x + (side === 'left' ? 4 : -4), 
                        y + 4 + j * 3, 
                        z - 12 + i * 6
                    );
                    scene.add(window);
                    
                    // Wooden frame
                    const frameGeometry = new THREE.BoxGeometry(1.7, 2.2, 0.4);
                    const frameMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x654321 // Dark wood
                    });
                    const frame = new THREE.Mesh(frameGeometry, frameMaterial);
                    frame.position.copy(window.position);
                    frame.position.z += 0.1;
                    scene.add(frame);
                }
            }
            
            // Wooden boxes and pottery (like in the image)
            if (side === 'left') {
                // Wooden boxes
                for (let i = 0; i < 3; i++) {
                    const boxGeometry = new THREE.BoxGeometry(1, 1, 1);
                    const boxMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x8B4513
                    });
                    const box = new THREE.Mesh(boxGeometry, boxMaterial);
                    box.position.set(x - 5, y + 0.5, z - 10 + i * 5);
                    box.castShadow = true;
                    box.receiveShadow = true;
                    scene.add(box);
                }
                
                // Pottery
                for (let i = 0; i < 2; i++) {
                    const potGeometry = new THREE.CylinderGeometry(0.5, 0.7, 1, 8);
                    const potMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x8B7355
                    });
                    const pot = new THREE.Mesh(potGeometry, potMaterial);
                    pot.position.set(x - 6, y + 0.5, z - 5 + i * 8);
                    pot.castShadow = true;
                    pot.receiveShadow = true;
                    scene.add(pot);
                }
            }
            
            // Plants and greenery on walls
            for (let i = 0; i < 5; i++) {
                const plantGeometry = new THREE.SphereGeometry(0.8, 8, 6);
                const plantMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x228B22 // Forest green
                });
                const plant = new THREE.Mesh(plantGeometry, plantMaterial);
                plant.position.set(
                    x + (side === 'left' ? 4.2 : -4.2), 
                    y + 2 + Math.random() * 6, 
                    z - 14 + i * 6
                );
                plant.castShadow = true;
                scene.add(plant);
            }
        }

        // Create environment elements
        function createEnvironment() {
            // Trees along the alley
            for (let i = 0; i < 8; i++) {
                const treeGroup = new THREE.Group();
                
                // Tree trunk
                const trunkGeometry = new THREE.CylinderGeometry(0.5, 0.7, 4, 8);
                const trunkMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x8B4513
                });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.y = 2;
                trunk.castShadow = true;
                treeGroup.add(trunk);
                
                // Tree leaves
                const leavesGeometry = new THREE.SphereGeometry(2, 8, 6);
                const leavesMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x228B22
                });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.y = 5;
                leaves.castShadow = true;
                treeGroup.add(leaves);
                
                // Position trees
                const side = i % 2 === 0 ? -20 : 20;
                treeGroup.position.set(side, 0, -15 + i * 5);
                scene.add(treeGroup);
            }
            
            // Additional plants and decorations
            for (let i = 0; i < 10; i++) {
                const plantGeometry = new THREE.ConeGeometry(0.5, 1.5, 6);
                const plantMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x2E7D32
                });
                const plant = new THREE.Mesh(plantGeometry, plantMaterial);
                plant.position.set(
                    (Math.random() - 0.5) * 40,
                    0.75,
                    (Math.random() - 0.5) * 40
                );
                plant.castShadow = true;
                plant.receiveShadow = true;
                scene.add(plant);
            }
        }

        // Create rooms with traditional styling
        function createRooms() {
            rooms.forEach((room, index) => {
                // Room size based on importance
                const size = room.name.includes("هۆڵی") ? 6 : 4;
                const roomGeometry = new THREE.BoxGeometry(size, 3, size);
                
                // Determine color based on floor and status
                let color;
                if (room.current) {
                    color = 0xFFD700; // Gold for current room
                } else if (room.visited) {
                    color = 0x90EE90; // Light green for visited
                } else if (room.floor === 'ground') {
                    color = 0xDEB887; // Burlywood for ground floor
                } else if (room.floor === 'first') {
                    color = 0xD2B48C; // Tan for first floor
                } else {
                    color = 0xBC9A6A; // Darker tan for second floor
                }
                
                const roomMaterial = new THREE.MeshLambertMaterial({ 
                    color: color,
                    transparent: true,
                    opacity: 0.8
                });
                const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                
                // Position the room
                roomMesh.position.set(room.x, room.y + 1.5, room.z);
                roomMesh.castShadow = true;
                roomMesh.receiveShadow = true;
                
                // Add traditional door to each room
                const doorGeometry = new THREE.BoxGeometry(1.5, 2.5, 0.3);
                const doorMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x654321
                });
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                door.position.set(room.x, room.y + 1.25, room.z + size/2);
                door.castShadow = true;
                scene.add(door);
                
                // Add label with traditional styling
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 80;
                
                // Background with traditional pattern
                const gradient = context.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#F5DEB3');
                gradient.addColorStop(1, '#DEB887');
                context.fillStyle = gradient;
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Border
                context.strokeStyle = '#8B4513';
                context.lineWidth = 3;
                context.strokeRect(5, 5, canvas.width-10, canvas.height-10);
                
                // Text
                context.fillStyle = '#654321';
                context.font = 'bold 18px Arial';
                context.textAlign = 'center';
                context.fillText(room.name, canvas.width/2, 35);
                
                context.fillStyle = '#8B4513';
                context.font = '14px Arial';
                context.fillText(room.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                               room.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم', 
                               canvas.width/2, 60);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ map: texture });
                const label = new THREE.Sprite(labelMaterial);
                label.position.set(room.x, room.y + 4, room.z);
                label.scale.set(6, 2.4, 1);
                
                // Store reference
                roomMesh.roomData = room;
                roomMesh.label = label;
                
                scene.add(roomMesh);
                scene.add(label);
                roomMeshes.push(roomMesh);
            });
        }

        // Create user position indicator
        function createUserIndicator() {
            // Create a 3D indicator for the user
            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xFFD700,
                transparent: true,
                opacity: 0.8
            });
            const userSphere = new THREE.Mesh(geometry, material);
            userSphere.position.set(userPosition.x, userPosition.y + 1.5, userPosition.z);
            scene.add(userSphere);
            
            // Add a cone for direction
            const coneGeometry = new THREE.ConeGeometry(0.3, 1, 8);
            const coneMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
            const directionCone = new THREE.Mesh(coneGeometry, coneMaterial);
            directionCone.position.set(userPosition.x, userPosition.y + 2.5, userPosition.z);
            directionCone.rotation.x = Math.PI;
            scene.add(directionCone);
            
            // Store references
            window.userIndicator = userSphere;
            window.directionIndicator = directionCone;
        }

        // Update user position
        function updateUserPosition(x, y, z) {
            userPosition = { x, y, z };
            
            // Update 3D indicator
            if (window.userIndicator && window.directionIndicator) {
                window.userIndicator.position.set(x, y + 1.5, z);
                window.directionIndicator.position.set(x, y + 2.5, z);
            }
            
            // Update 2D overlay indicator
            updateUserPositionOverlay(x, z);
            
            // Update current floor based on y position
            if (y < 1.5) userFloor = "ground";
            else if (y < 4.5) userFloor = "first";
            else userFloor = "second";
            
            // Check if user is near any room
            checkUserNearRooms();
        }

        // Update 2D overlay indicator position
        function updateUserPositionOverlay(x, z) {
            const viewer = document.getElementById('3d-viewer');
            const width = viewer.clientWidth;
            const height = viewer.clientHeight;
            
            // Convert 3D coordinates to screen coordinates
            const screenX = (x + 20) / 40 * width;
            const screenY = (z + 20) / 40 * height;
            
            userPositionEl.style.left = `${screenX - 20}px`;
            userPositionEl.style.top = `${screenY - 20}px`;
            userPositionEl.style.display = 'block';
        }

        // Check if user is near any rooms
        function checkUserNearRooms() {
            rooms.forEach((room, index) => {
                const dx = room.x - userPosition.x;
                const dz = room.z - userPosition.z;
                const distance = Math.sqrt(dx*dx + dz*dz);
                
                // If user is close to a room and it's on the same floor
                if (distance < 3 && room.floor === userFloor && !room.visited) {
                    // Mark as visited
                    room.visited = true;
                    visitedRooms++;
                    
                    // Update room color
                    updateRoomColor(index);
                    
                    // Show notification
                    showToast("هۆڵی نوێ", `سەردانی ${room.name} کرایەوە`);
                    
                    // Update progress
                    updateProgress();
                }
            });
        }

        // Update room color
        function updateRoomColor(index) {
            const room = rooms[index];
            const roomMesh = roomMeshes[index];
            
            if (!roomMesh) return;
            
            let color;
            if (room.current) {
                color = 0xFFD700;
            } else if (room.visited) {
                color = 0x90EE90;
            } else if (room.floor === 'ground') {
                color = 0xDEB887;
            } else if (room.floor === 'first') {
                color = 0xD2B48C;
            } else {
                color = 0xBC9A6A;
            }
            
            roomMesh.material.color.setHex(color);
        }

        // Go to specific room
        function goToRoom(roomId) {
            const roomIndex = rooms.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            // Mark as visited
            if (!rooms[roomIndex].visited) {
                rooms[roomIndex].visited = true;
                visitedRooms++;
            }
            
            // Update current room
            rooms.forEach(room => room.current = false);
            rooms[roomIndex].current = true;
            currentRoomIndex = roomIndex;
            
            // Move user to this room
            const targetRoom = rooms[roomIndex];
            updateUserPosition(targetRoom.x, targetRoom.y, targetRoom.z);
            
            // Update all room colors
            rooms.forEach((room, index) => {
                updateRoomColor(index);
            });
            
            // Update UI
            updateUI();
            
            // Update room info if panel is open
            if (roomInfoPanel.classList.contains('open')) {
                loadRoomDetails();
            }
            
            // Show direction info
            updateDirectionInfo();
        }

        // Go to next room
        function nextRoom() {
            const nextIndex = (currentRoomIndex + 1) % rooms.length;
            goToRoom(rooms[nextIndex].id);
        }

        // Go to previous room
        function prevRoom() {
            const prevIndex = (currentRoomIndex - 1 + rooms.length) % rooms.length;
            goToRoom(rooms[prevIndex].id);
        }

        // Start/stop auto tour
        function toggleAutoTour() {
            isAutoTour = !isAutoTour;
            
            if (isAutoTour) {
                autoTourBtn.classList.add('active');
                autoTourBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                // Start tour
                let roomIndex = 0;
                tourInterval = setInterval(() => {
                    goToRoom(rooms[roomIndex].id);
                    roomIndex = (roomIndex + 1) % rooms.length;
                    
                    // Stop if all rooms visited
                    if (roomIndex === 0) {
                        toggleAutoTour();
                        showToast("سەردانی تەواو", "هەموو هۆڵەکان سەردان کران!");
                    }
                }, 4000);
            } else {
                autoTourBtn.classList.remove('active');
                autoTourBtn.innerHTML = '<i class="fas fa-play"></i>';
                
                // Stop tour
                if (tourInterval) {
                    clearInterval(tourInterval);
                }
            }
        }

        // Update UI
        function updateUI() {
            const currentRoom = rooms[currentRoomIndex];
            const visitedCount = rooms.filter(r => r.visited).length;
            const totalRooms = rooms.length;
            const percentage = Math.round((visitedCount / totalRooms) * 100);
            
            currentRoomName.textContent = currentRoom.name;
            currentRoomFloor.textContent = currentRoom.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                                          currentRoom.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم';
            
            tourProgress.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
            
            // Update location status
            if (hasLocationPermission) {
                locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span>لۆکەیشن چالاکە</span>`;
                locationStatus.style.background = "rgba(144, 238, 144, 0.2)";
                locationStatus.style.borderColor = "rgba(144, 238, 144, 0.4)";
            } else {
                locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span>لۆکەیشن ناچالاکە</span>`;
                locationStatus.style.background = "rgba(255, 140, 0, 0.2)";
                locationStatus.style.borderColor = "rgba(255, 140, 0, 0.4)";
            }
        }

        // Update progress
        function updateProgress() {
            const visitedCount = rooms.filter(r => r.visited).length;
            const totalRooms = rooms.length;
            const percentage = Math.round((visitedCount / totalRooms) * 100);
            
            tourProgress.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
        }

        // Load room details into panel
        function loadRoomDetails() {
            const currentRoom = rooms[currentRoomIndex];
            
            roomDetails.innerHTML = `
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">ناوی هۆڵ</div>
                        <div class="detail-value">${currentRoom.name}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">نهۆم</div>
                        <div class="detail-value">${currentRoom.floor === 'ground' ? 'سەرەتایی' : 
                                                   currentRoom.floor === 'first' ? 'یەکەم' : 'دووەم'}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">زانیاری</div>
                        <div class="detail-value">${currentRoom.details}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-road"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">دووری</div>
                        <div class="detail-value">${currentRoom.distance} مەتر</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">وەسف</div>
                        <div class="detail-value">${currentRoom.description}</div>
                    </div>
                </div>
            `;
            
            updateDirectionInfo();
        }

        // Update direction information
        function updateDirectionInfo() {
            const currentRoom = rooms[currentRoomIndex];
            const userRoom = rooms.find(r => 
                Math.abs(r.x - userPosition.x) < 1 && 
                Math.abs(r.z - userPosition.z) < 1 &&
                r.floor === userFloor
            );
            
            let direction = "";
            
            if (currentRoom.id === 1) {
                direction = "ئێستا لە دەرگای سەرەکیدایت. بۆ چوونە ناوەوە، بە ڕاست بڕۆ.";
            } else if (currentRoom.floor !== userFloor) {
                direction = `بۆ گەیشتن بەم هۆڵە، پێویستە بچیتە سەر ${currentRoom.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم'}. پەیجی پلەیەکان لە لای ڕاستەوە`;
            } else {
                const dx = currentRoom.x - userPosition.x;
                const dz = currentRoom.z - userPosition.z;
                
                if (Math.abs(dx) > Math.abs(dz)) {
                    direction = dx > 0 ? "بۆ گەیشتن بەم هۆڵە، بە ڕاست بڕۆ" : "بۆ گەیشتن بەم هۆڵە، بە چەپ بڕۆ";
                } else {
                    direction = dz > 0 ? "بۆ گەیشتن بەم هۆڵە، بە پێشەوە بڕۆ" : "بۆ گەیشتن بەم هۆڵە، بە دواوە بڕۆ";
                }
                
                if (userRoom) {
                    direction += ` لە ${userRoom.name}`;
                }
                
                direction += `. دووری نزیکەی ${currentRoom.distance} مەترە.`;
            }
            
            directionText.textContent = direction;
        }

        // Show/hide room info panel
        function toggleRoomInfoPanel() {
            if (roomInfoPanel.classList.contains('open')) {
                roomInfoPanel.classList.remove('open');
            } else {
                roomInfoPanel.classList.add('open');
                loadRoomDetails();
            }
        }

        // Show toast notification
        function showToast(title, message) {
            toastTitle.textContent = title;
            toastText.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Setup touch controls for movement
        function setupTouchControls() {
            const joystick = document.querySelector('.joystick');
            let touchId = null;
            
            // Touch events for joystick
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchId = e.changedTouches[0].identifier;
                joystickActive = true;
            });
            
            joystick.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                
                e.preventDefault();
                const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
                if (!touch) return;
                
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const deltaX = touch.clientX - centerX;
                const deltaY = touch.clientY - centerY;
                
                // Limit joystick movement
                const distance = Math.min(Math.sqrt(deltaX*deltaX + deltaY*deltaY), 35);
                const angle = Math.atan2(deltaY, deltaX);
                
                joystickPosition.x = Math.cos(angle) * distance;
                joystickPosition.y = Math.sin(angle) * distance;
                
                // Update joystick handle position
                joystickHandle.style.transform = `translate(${joystickPosition.x}px, ${joystickPosition.y}px)`;
                
                // Move user based on joystick
                moveUser(joystickPosition.x / 35, -joystickPosition.y / 35);
            });
            
            joystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickPosition = { x: 0, y: 0 };
                joystickHandle.style.transform = 'translate(0, 0)';
                touchId = null;
            });
            
            // Zoom buttons
            zoomInBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                camera.position.y = Math.max(5, camera.position.y - 2);
            });
            
            zoomOutBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                camera.position.y = Math.min(50, camera.position.y + 2);
            });
            
            // Prevent default touch behaviors
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.joystick') || e.target.closest('.touch-btn')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Move user based on joystick input
        function moveUser(x, z) {
            const speed = 0.3;
            const newX = userPosition.x + x * speed;
            const newZ = userPosition.z + z * speed;
            
            // Keep user within bounds
            if (newX > -20 && newX < 20 && newZ > -20 && newZ < 20) {
                updateUserPosition(newX, userPosition.y, newZ);
            }
        }

        // Handle window resize
        function onWindowResize() {
            const canvas = document.getElementById('3d-viewer');
            const container = canvas.parentElement;
            
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
            
            // Rotate room labels to face camera
            roomMeshes.forEach(mesh => {
                if (mesh.label) {
                    mesh.label.lookAt(camera.position);
                }
            });
            
            // Update direction indicator rotation
            if (window.directionIndicator && joystickActive) {
                const angle = Math.atan2(-joystickPosition.y, joystickPosition.x);
                window.directionIndicator.rotation.y = -angle;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Location permission buttons
            allowLocationBtn.addEventListener('click', async () => {
                try {
                    const position = await getLocation();
                    hasLocationPermission = true;
                    permissionModal.style.display = 'none';
                    
                    // Simulate starting from a random room based on "location"
                    const randomRoom = Math.floor(Math.random() * 8) + 2;
                    goToRoom(randomRoom);
                    
                    showToast("لۆکەیشن چالاک کرایەوە", "ئێستا شوێنی ڕاستەقینەت نیشان دەدرێت");
                } catch (error) {
                    showToast("کێشەی لۆکەیشن", "نەتوانرا لۆکەیشن بەدەست بێت");
                    permissionModal.style.display = 'none';
                    goToRoom(1);
                }
            });
            
            denyLocationBtn.addEventListener('click', () => {
                hasLocationPermission = false;
                permissionModal.style.display = 'none';
                goToRoom(1);
                showToast("سەردانی دەستی", "دەتوانیت بە دەستی خۆت بگەڕێیت");
            });
            
            // Navigation buttons
            prevRoomBtn.addEventListener('click', prevRoom);
            nextRoomBtn.addEventListener('click', nextRoom);
            autoTourBtn.addEventListener('click', toggleAutoTour);
            infoBtn.addEventListener('click', toggleRoomInfoPanel);
            closePanelBtn.addEventListener('click', toggleRoomInfoPanel);
            
            // Swipe gestures for mobile
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].clientX;
                touchStartY = e.changedTouches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // Swipe right (next room)
                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    if (diffX > 0) {
                        nextRoom();
                    } else {
                        prevRoom();
                    }
                }
                
                // Swipe up/down for info panel
                if (Math.abs(diffY) > 50 && Math.abs(diffY) > Math.abs(diffX)) {
                    if (diffY > 0 && !roomInfoPanel.classList.contains('open')) {
                        toggleRoomInfoPanel();
                    } else if (diffY < 0 && roomInfoPanel.classList.contains('open')) {
                        toggleRoomInfoPanel();
                    }
                }
            });
            
            // Close panel when clicking outside
            roomInfoPanel.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            });
            
            document.addEventListener('touchstart', (e) => {
                if (roomInfoPanel.classList.contains('open') && 
                    !e.target.closest('.room-info-panel') && 
                    !e.target.closest('#infoBtn')) {
                    toggleRoomInfoPanel();
                }
            });
            
            // Handle device orientation for movement
            if (window.DeviceOrientationEvent && hasLocationPermission) {
                window.addEventListener('deviceorientation', (e) => {
                    // Use tilt to move in the building
                    if (e.beta && e.gamma) {
                        const tiltX = (e.gamma || 0) / 45;
                        const tiltZ = (e.beta || 0 - 90) / 45;
                        
                        // Move user based on tilt (subtle movement)
                        moveUser(tiltX * 0.1, tiltZ * 0.1);
                    }
                });
            }
        }

        // Get user location
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation not supported"));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            });
        }

        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Prevent scrolling on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.room-info-panel')) {
                return; // Allow scrolling in info panel
            }
            e.preventDefault();
        }, { passive: false });

        // Handle back button to close panel
        document.addEventListener('backbutton', toggleRoomInfoPanel, false);
    </script>
</body>
</html>