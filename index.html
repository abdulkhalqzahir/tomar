<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سەردانی 3Dی کۆلێژی بەڕێوەبردن و ئابووری - زانکۆی سەڵاحەدین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c1d4d 0%, #1a3a8f 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            direction: rtl;
        }

        .container {
            max-width: 100%;
            padding: 20px;
        }

        header {
            background: rgba(13, 43, 109, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #ffcc00;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a3a8f;
            font-size: 35px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .title {
            text-align: right;
        }

        h1 {
            font-size: 26px;
            margin-bottom: 5px;
            color: white;
        }

        h2 {
            font-size: 20px;
            color: #ffcc00;
            font-weight: 600;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .viewer-container {
            flex: 3;
            min-width: 300px;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
            position: relative;
            background-color: #0a1930;
        }

        #3d-viewer {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            z-index: 100;
        }

        .controls-overlay h3 {
            margin-bottom: 10px;
            color: #ffcc00;
        }

        .controls-overlay ul {
            list-style: none;
            padding-right: 10px;
        }

        .controls-overlay li {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .tour-controls {
            position: absolute;
            bottom: 20px;
            right: 50%;
            transform: translateX(50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .tour-btn {
            padding: 12px 25px;
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #0c1d4d;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.4);
            transition: all 0.3s;
        }

        .tour-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 204, 0, 0.6);
        }

        .tour-btn:active {
            transform: translateY(1px);
        }

        .info-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .location-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-right: 5px solid #ffcc00;
        }

        .location-info h3 {
            color: #ffcc00;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .current-location {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .location-details {
            line-height: 1.6;
        }

        .visitor-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed rgba(255, 255, 255, 0.3);
        }

        .visitor-stats h4 {
            color: #ffcc00;
            margin-bottom: 10px;
        }

        .progress-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #00c853, #64dd17);
            border-radius: 10px;
            width: 0%;
            transition: width 1.5s ease-in-out;
        }

        .rooms-list {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .rooms-list::-webkit-scrollbar {
            width: 8px;
        }

        .rooms-list::-webkit-scrollbar-thumb {
            background: #ffcc00;
            border-radius: 10px;
        }

        .room-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 3px solid transparent;
        }

        .room-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
            border-right: 3px solid #ffcc00;
        }

        .room-item.visited {
            border-right: 3px solid #00c853;
        }

        .room-item.current {
            background: rgba(255, 204, 0, 0.25);
            border-right: 3px solid #ffcc00;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .room-name {
            font-weight: bold;
            font-size: 18px;
            color: white;
        }

        .room-floor {
            background: rgba(255, 204, 0, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #ffcc00;
        }

        .room-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        footer {
            background: rgba(13, 43, 109, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffcc00;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .designer {
            margin-top: 10px;
            font-style: italic;
            color: #ffcc00;
        }

        .location-permission {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            padding: 20px;
            text-align: center;
        }

        .permission-box {
            background: linear-gradient(135deg, #1a3a8f 0%, #0c1d4d 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            border: 3px solid #ffcc00;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .permission-box h2 {
            color: #ffcc00;
            margin-bottom: 20px;
        }

        .permission-box p {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .permission-btns {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .permission-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .permission-btn.allow {
            background: linear-gradient(to right, #00c853, #64dd17);
            color: white;
        }

        .permission-btn.deny {
            background: linear-gradient(to right, #ff3d00, #ff9100);
            color: white;
        }

        .permission-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .viewer-container {
                height: 400px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tour-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .controls-overlay {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Location Permission Modal -->
    <div class="location-permission" id="locationPermission">
        <div class="permission-box">
            <h2><i class="fas fa-map-marker-alt"></i> دەستپێکردنی سەردانی 3D</h2>
            <p>بۆ ئەوەی بتوانین سەردانی ئۆتۆماتیکی 3D بۆ هۆڵەکانی کۆلێژ بکەین، پێویستە ڕێگە بدەیت بە وێبپەڕەکە کە لۆکەیشنی ئێستای تۆ بەکاربهێنێت.</p>
            <p>ئەم زانیاریە تەنها بۆ پێشاندانی سەردانی ئۆتۆماتیکی بەکاردەهێنرێت و هەرگیز نەگواسترێتەوە یەکێکی تر.</p>
            <div class="permission-btns">
                <button class="permission-btn allow" id="allowLocation">
                    <i class="fas fa-check-circle"></i> ڕێگەدان بە لۆکەیشن
                </button>
                <button class="permission-btn deny" id="denyLocation">
                    <i class="fas fa-times-circle"></i> ڕێگە نەدان (سەردانی دەستی)
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">س</div>
                    <div class="title">
                        <h1>زانکۆی سەڵاحەدین</h1>
                        <h2>سەردانی 3Dی کۆلێژی بەڕێوەبردن و ئابووری</h2>
                    </div>
                </div>
                <div class="current-location">
                    <i class="fas fa-map-pin"></i>
                    <span id="currentLocationText">لۆکەیشن: چاوەڕوانی ڕێگەدان...</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="viewer-container">
                <canvas id="3d-viewer"></canvas>
                
                <div class="controls-overlay">
                    <h3><i class="fas fa-gamepad"></i> کۆنترۆڵەکان:</h3>
                    <ul>
                        <li><i class="fas fa-mouse-pointer"></i> ڕاکێشان: سوڕاندنی بینین</li>
                        <li><i class="fas fa-mouse"></i> کلیکی ڕاست: جوڵاندن</li>
                        <li><i class="fas fa-mouse"></i> ماووس سکرۆڵ: نزیک/دوورکردنەوە</li>
                        <li><i class="fas fa-arrows-alt"></i> WASD: جوڵاندن لە ناو نەخشەکەدا</li>
                    </ul>
                </div>
                
                <div class="tour-controls">
                    <button class="tour-btn" id="startTour">
                        <i class="fas fa-play"></i> دەستپێکردنی سەردانی ئۆتۆماتیکی
                    </button>
                    <button class="tour-btn" id="pauseTour">
                        <i class="fas fa-pause"></i> وەستان
                    </button>
                    <button class="tour-btn" id="resetTour">
                        <i class="fas fa-redo"></i> دەستپێکردنەوە
                    </button>
                </div>
            </div>

            <div class="info-panel">
                <div class="location-info">
                    <h3><i class="fas fa-info-circle"></i> زانیاری سەردان</h3>
                    <div class="location-details">
                        <p>ئێستا سەردانی: <strong id="currentRoomName">دەرگای سەرەکی</strong></p>
                        <p>شوێن: <strong id="currentRoomFloor">نهۆمی سەرەتایی</strong></p>
                        <p>سەردانکراوە: <strong id="visitedRoomsCount">0 لە 23</strong></p>
                    </div>
                    
                    <div class="visitor-stats">
                        <h4>پێشی سەردانکردن:</h4>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="tourProgress"></div>
                            </div>
                            <p>تەواوکردنی سەردان: <span id="progressPercent">0%</span></p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #ffcc00; margin-bottom: 15px;">
                    <i class="fas fa-door-open"></i> هۆڵەکانی کۆلێژ
                </h3>
                
                <div class="rooms-list" id="roomsList">
                    <!-- Room list will be dynamically added -->
                </div>
            </div>
        </div>

        <footer>
            <p>کۆلێژی بەڕێوەبردن و ئابووری - زانکۆی سەڵاحەدین &copy; ٢٠٢٥</p>
            <p class="designer"><i class="fas fa-paint-brush"></i> دیزاین: دژوار گەنجۆ گیبرەیڵی</p>
            <p><i class="fas fa-map-marker-alt"></i> سەردانی 3Dی ئۆتۆماتیکی - بەکارهێنانی لۆکەیشنی ڕاستەقینە</p>
        </footer>
    </div>

    <script>
        // Room data
        const rooms = [
            { id: 1, name: "دەرگای سەرەکی", floor: "ground", x: 0, y: 0, z: 15, visited: true, current: true, details: "دەرگای سەرەکی چوونە ناو کۆلێژەوە" },
            { id: 2, name: "ئەکاونتی", floor: "first", x: -5, y: 3, z: 10, visited: false, current: false, details: "بەشی ئەکاونتی - نهۆمی یەکەم" },
            { id: 3, name: "ئابووری", floor: "first", x: 5, y: 3, z: 10, visited: false, current: false, details: "بەشی ئابووری - نهۆمی یەکەم" },
            { id: 4, name: "کتێبخانە", floor: "ground", x: -8, y: 0, z: 5, visited: false, current: false, details: "کتێبخانەی کۆلێژ" },
            { id: 5, name: "موسڵمانان", floor: "ground", x: 10, y: 0, z: 0, visited: false, current: false, details: "موسڵمانی نێرینە" },
            { id: 6, name: "تەوالێت (نێرینە)", floor: "ground", x: 12, y: 0, z: -5, visited: false, current: false, details: "تەوالێتی نێرینە" },
            { id: 7, name: "تەوالێت (مێینە)", floor: "ground", x: -12, y: 0, z: -5, visited: false, current: false, details: "تەوالێتی مێینە" },
            { id: 8, name: "وەرگرتنی خوێندکار", floor: "ground", x: -5, y: 0, z: -10, visited: false, current: false, details: "بەشی وەرگرتنی خوێندکارە نوێیەکان" },
            { id: 9, name: "ئامادەبوون", floor: "ground", x: 5, y: 0, z: -10, visited: false, current: false, details: "ئامادەبوونی خوێندکاران" },
            { id: 10, name: "پارێزەر", floor: "ground", x: 15, y: 0, z: 8, visited: false, current: false, details: "پارێزەری کۆلێژ" },
            { id: 11, name: "پێشوازیکردن", floor: "ground", x: 0, y: 0, z: 12, visited: false, current: false, details: "ژووری پێشوازیکردن" },
            { id: 12, name: "چاپ", floor: "ground", x: -15, y: 0, z: 8, visited: false, current: false, details: "بەشی چاپکردن" },
            { id: 13, name: "کافێ", floor: "ground", x: -10, y: 0, z: -12, visited: false, current: false, details: "کافێی کۆلێژ" },
            { id: 14, name: "دوکان", floor: "ground", x: 10, y: 0, z: -12, visited: false, current: false, details: "دوکانی کۆلێژ" },
            { id: 15, name: "وەرزش", floor: "ground", x: 0, y: 0, z: -15, visited: false, current: false, details: "بەشی وەرزشی" },
            { id: 16, name: "مارکێتینگ", floor: "ground", x: -15, y: 0, z: -8, visited: false, current: false, details: "بەشی مارکێتینگ" },
            { id: 17, name: "ئامار", floor: "second", x: -5, y: 6, z: 10, visited: false, current: false, details: "بەشی ئامار - نهۆمی دووەم" },
            { id: 18, name: "دارایی و بانکداری", floor: "second", x: 5, y: 6, z: 10, visited: false, current: false, details: "بەشی دارایی و بانکداری - نهۆمی دووەم" },
            { id: 19, name: "دەزگای کۆلێژ", floor: "second", x: 0, y: 6, z: 0, visited: false, current: false, details: "دەزگای کۆلێژ - نهۆمی دووەم" },
            { id: 20, name: "یەکەکانی ئەکاونتی", floor: "second", x: -8, y: 6, z: 5, visited: false, current: false, details: "یەکەکانی بەشی ئەکاونتی - نهۆمی دووەم" },
            { id: 21, name: "هۆڵی د. بەیان", floor: "second", x: 8, y: 6, z: 5, visited: false, current: false, details: "هۆڵی دکتۆر بەیان - نهۆمی دووەم" },
            { id: 22, name: "هۆڵی شەهید گەرەداغی", floor: "first", x: -10, y: 3, z: -5, visited: false, current: false, details: "هۆڵی شەهید گەرەداغی - نهۆمی یەکەم" },
            { id: 23, name: "هۆڵی ئاشتی", floor: "first", x: 10, y: 3, z: -5, visited: false, current: false, details: "هۆڵی ئاشتی - نهۆمی یەکەم" },
            { id: 24, name: "یەکێتی خوێندکاران", floor: "first", x: 0, y: 3, z: -5, visited: false, current: false, details: "یەکێتی خوێندکاران - نهۆمی یەکەم" }
        ];

        // Global variables
        let scene, camera, renderer, controls;
        let roomMeshes = [];
        let currentRoomIndex = 0;
        let isTourActive = false;
        let tourInterval;
        let userLocation = null;
        let hasLocationPermission = false;
        let visitedRooms = 1; // Starting with the main door
        
        // DOM elements
        const locationPermission = document.getElementById('locationPermission');
        const allowLocationBtn = document.getElementById('allowLocation');
        const denyLocationBtn = document.getElementById('denyLocation');
        const startTourBtn = document.getElementById('startTour');
        const pauseTourBtn = document.getElementById('pauseTour');
        const resetTourBtn = document.getElementById('resetTour');
        const currentLocationText = document.getElementById('currentLocationText');
        const currentRoomName = document.getElementById('currentRoomName');
        const currentRoomFloor = document.getElementById('currentRoomFloor');
        const visitedRoomsCount = document.getElementById('visitedRoomsCount');
        const tourProgress = document.getElementById('tourProgress');
        const progressPercent = document.getElementById('progressPercent');
        const roomsList = document.getElementById('roomsList');

        // Initialize the application
        function init() {
            // Request location permission on load
            showLocationPermission();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize 3D scene
            init3DScene();
            
            // Create room list
            createRoomList();
            
            // Update UI
            updateUI();
            
            // Start animation loop
            animate();
        }

        // Show location permission modal
        function showLocationPermission() {
            locationPermission.style.display = 'flex';
        }

        // Hide location permission modal
        function hideLocationPermission() {
            locationPermission.style.display = 'none';
        }

        // Initialize 3D scene
        function init3DScene() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1930);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 30);
            
            // Create renderer
            const canvas = document.getElementById('3d-viewer');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 50;
            controls.maxPolarAngle = Math.PI / 2;
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Create building structure
            createBuilding();
            
            // Create rooms
            createRooms();
            
            // Add grid helper
            const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        // Create building structure
        function createBuilding() {
            // Ground floor
            const groundGeometry = new THREE.BoxGeometry(40, 0.5, 40);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2c5aa0 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.position.y = -0.25;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // First floor
            const firstFloorGeometry = new THREE.BoxGeometry(35, 0.5, 35);
            const firstFloorMaterial = new THREE.MeshLambertMaterial({ color: 0x3a6bb8 });
            const firstFloor = new THREE.Mesh(firstFloorGeometry, firstFloorMaterial);
            firstFloor.position.y = 3;
            firstFloor.receiveShadow = true;
            scene.add(firstFloor);
            
            // Second floor
            const secondFloorGeometry = new THREE.BoxGeometry(30, 0.5, 30);
            const secondFloorMaterial = new THREE.MeshLambertMaterial({ color: 0x4a7cc8 });
            const secondFloor = new THREE.Mesh(secondFloorGeometry, secondFloorMaterial);
            secondFloor.position.y = 6;
            secondFloor.receiveShadow = true;
            scene.add(secondFloor);
            
            // Stairs between floors
            for (let i = 0; i < 10; i++) {
                const stairGeometry = new THREE.BoxGeometry(2, 0.2, 0.8);
                const stairMaterial = new THREE.MeshLambertMaterial({ color: 0xcccccc });
                const stair = new THREE.Mesh(stairGeometry, stairMaterial);
                stair.position.set(-15 + i * 0.5, i * 0.3, 12);
                stair.receiveShadow = true;
                stair.castShadow = true;
                scene.add(stair);
            }
            
            // Building walls (simplified)
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x1a3a8f });
            
            // Outer walls
            const wallGeometry = new THREE.BoxGeometry(40, 7, 1);
            const northWall = new THREE.Mesh(wallGeometry, wallMaterial);
            northWall.position.set(0, 3.5, -20);
            northWall.castShadow = true;
            northWall.receiveShadow = true;
            scene.add(northWall);
            
            const southWall = new THREE.Mesh(wallGeometry, wallMaterial);
            southWall.position.set(0, 3.5, 20);
            southWall.castShadow = true;
            southWall.receiveShadow = true;
            scene.add(southWall);
            
            const eastWall = new THREE.Mesh(new THREE.BoxGeometry(1, 7, 40), wallMaterial);
            eastWall.position.set(20, 3.5, 0);
            eastWall.castShadow = true;
            eastWall.receiveShadow = true;
            scene.add(eastWall);
            
            const westWall = new THREE.Mesh(new THREE.BoxGeometry(1, 7, 40), wallMaterial);
            westWall.position.set(-20, 3.5, 0);
            westWall.castShadow = true;
            westWall.receiveShadow = true;
            scene.add(westWall);
        }

        // Create rooms in 3D
        function createRooms() {
            const roomGeometry = new THREE.BoxGeometry(4, 2, 4);
            
            rooms.forEach((room, index) => {
                // Determine room color based on floor
                let roomColor;
                if (room.floor === 'ground') roomColor = 0x2c5aa0;
                else if (room.floor === 'first') roomColor = 0x3a6bb8;
                else roomColor = 0x4a7cc8;
                
                // Special color for current room
                if (room.current) roomColor = 0xffcc00;
                
                const roomMaterial = new THREE.MeshLambertMaterial({ color: roomColor });
                const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                
                // Position the room
                roomMesh.position.set(room.x, room.y + 1, room.z);
                roomMesh.castShadow = true;
                roomMesh.receiveShadow = true;
                
                // Add label
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 128;
                
                context.fillStyle = 'rgba(255, 255, 255, 0.8)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                context.fillStyle = '#1a3a8f';
                context.font = 'bold 24px Arial';
                context.textAlign = 'center';
                context.fillText(room.name, canvas.width/2, 40);
                
                context.fillStyle = '#555';
                context.font = '16px Arial';
                context.fillText(room.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                               room.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم', 
                               canvas.width/2, 70);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ map: texture });
                const label = new THREE.Sprite(labelMaterial);
                label.position.set(room.x, room.y + 3, room.z);
                label.scale.set(8, 4, 1);
                
                // Store room data with mesh
                roomMesh.roomData = room;
                roomMesh.label = label;
                
                scene.add(roomMesh);
                scene.add(label);
                
                roomMeshes.push(roomMesh);
            });
        }

        // Create room list in sidebar
        function createRoomList() {
            roomsList.innerHTML = '';
            
            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                if (room.visited) roomItem.classList.add('visited');
                if (room.current) roomItem.classList.add('current');
                roomItem.dataset.id = room.id;
                
                roomItem.innerHTML = `
                    <div class="room-header">
                        <div class="room-name">${room.name}</div>
                        <div class="room-floor">${room.floor === 'ground' ? 'سەرەتایی' : 
                                                 room.floor === 'first' ? 'یەکەم' : 'دووەم'}</div>
                    </div>
                    <div class="room-details">${room.details}</div>
                    ${room.visited ? '<div style="margin-top: 8px; color: #00c853; font-size: 12px;"><i class="fas fa-check-circle"></i> سەردانکراوە</div>' : ''}
                `;
                
                roomItem.addEventListener('click', () => {
                    goToRoom(room.id);
                });
                
                roomsList.appendChild(roomItem);
            });
        }

        // Update UI elements
        function updateUI() {
            const currentRoom = rooms[currentRoomIndex];
            const visitedCount = rooms.filter(r => r.visited).length;
            const totalRooms = rooms.length;
            const percentage = Math.round((visitedCount / totalRooms) * 100);
            
            currentRoomName.textContent = currentRoom.name;
            currentRoomFloor.textContent = currentRoom.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                                          currentRoom.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم';
            visitedRoomsCount.textContent = `${visitedCount} لە ${totalRooms}`;
            tourProgress.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
            
            // Update location text based on permission
            if (hasLocationPermission && userLocation) {
                currentLocationText.innerHTML = `<i class="fas fa-map-marker-alt"></i> لۆکەیشن: چالاک (سەردانی ئۆتۆماتیکی)`;
            } else {
                currentLocationText.innerHTML = `<i class="fas fa-map-marker-alt"></i> لۆکەیشن: سەردانی دەستی`;
            }
        }

        // Go to a specific room
        function goToRoom(roomId) {
            const roomIndex = rooms.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            // Mark as visited
            if (!rooms[roomIndex].visited) {
                rooms[roomIndex].visited = true;
                visitedRooms++;
            }
            
            // Update current room
            rooms.forEach(room => room.current = false);
            rooms[roomIndex].current = true;
            currentRoomIndex = roomIndex;
            
            // Update 3D room colors
            updateRoomColors();
            
            // Move camera to room
            const targetRoom = rooms[roomIndex];
            const targetPosition = new THREE.Vector3(
                targetRoom.x, 
                targetRoom.y + 5, 
                targetRoom.z + 10
            );
            
            // Animate camera movement
            animateCameraToPosition(targetPosition);
            
            // Update UI
            updateUI();
            createRoomList();
        }

        // Update room colors in 3D scene
        function updateRoomColors() {
            roomMeshes.forEach((mesh, index) => {
                const room = rooms[index];
                let roomColor;
                
                if (room.floor === 'ground') roomColor = 0x2c5aa0;
                else if (room.floor === 'first') roomColor = 0x3a6bb8;
                else roomColor = 0x4a7cc8;
                
                if (room.current) roomColor = 0xffcc00;
                else if (room.visited) roomColor = 0x00c853;
                
                mesh.material.color.setHex(roomColor);
            });
        }

        // Animate camera to a position
        function animateCameraToPosition(targetPosition) {
            const startPosition = camera.position.clone();
            const startTime = Date.now();
            const duration = 1500; // 1.5 seconds
            
            function animateCamera() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function
                const easeProgress = progress < 0.5 
                    ? 2 * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                camera.position.lerpVectors(startPosition, targetPosition, easeProgress);
                
                if (progress < 1) {
                    requestAnimationFrame(animateCamera);
                } else {
                    // Look at the room
                    controls.target.set(
                        rooms[currentRoomIndex].x,
                        rooms[currentRoomIndex].y + 1,
                        rooms[currentRoomIndex].z
                    );
                }
            }
            
            animateCamera();
        }

        // Start automatic tour
        function startTour() {
            if (isTourActive) return;
            
            isTourActive = true;
            startTourBtn.innerHTML = '<i class="fas fa-play"></i> سەردان بەردەوامە';
            
            // If we have location, simulate based on location
            if (hasLocationPermission && userLocation) {
                startLocationBasedTour();
            } else {
                startSequentialTour();
            }
        }

        // Start sequential tour (room by room)
        function startSequentialTour() {
            let roomIndex = 0;
            
            tourInterval = setInterval(() => {
                goToRoom(rooms[roomIndex].id);
                roomIndex = (roomIndex + 1) % rooms.length;
                
                // Pause tour if all rooms visited
                if (roomIndex === 0) {
                    pauseTour();
                    alert('سەردانی 3D تەواو بوو! هەموو هۆڵەکان سەردان کران.');
                }
            }, 3000); // 3 seconds per room
        }

        // Start location-based tour (simulated)
        function startLocationBasedTour() {
            // Simulate user moving through the building based on location
            // In a real app, this would use actual geolocation data
            
            // Start from current location
            let currentIndex = currentRoomIndex;
            
            tourInterval = setInterval(() => {
                // Simulate moving to nearby rooms
                const nearbyRooms = rooms.filter((room, index) => {
                    if (index === currentIndex) return false;
                    
                    // Calculate distance from current room
                    const dx = room.x - rooms[currentIndex].x;
                    const dz = room.z - rooms[currentIndex].z;
                    const distance = Math.sqrt(dx*dx + dz*dz);
                    
                    return distance < 10; // Only rooms within 10 units
                });
                
                // If no nearby rooms, go to random room
                if (nearbyRooms.length === 0) {
                    currentIndex = Math.floor(Math.random() * rooms.length);
                } else {
                    // Go to a random nearby room
                    const randomRoom = nearbyRooms[Math.floor(Math.random() * nearbyRooms.length)];
                    currentIndex = rooms.findIndex(r => r.id === randomRoom.id);
                }
                
                goToRoom(rooms[currentIndex].id);
            }, 2500); // 2.5 seconds per room
        }

        // Pause tour
        function pauseTour() {
            if (!isTourActive) return;
            
            isTourActive = false;
            clearInterval(tourInterval);
            startTourBtn.innerHTML = '<i class="fas fa-play"></i> دەستپێکردنی سەردانی ئۆتۆماتیکی';
        }

        // Reset tour
        function resetTour() {
            pauseTour();
            
            // Reset all rooms
            rooms.forEach(room => {
                room.visited = false;
                room.current = false;
            });
            
            // Set first room as current and visited
            rooms[0].visited = true;
            rooms[0].current = true;
            currentRoomIndex = 0;
            visitedRooms = 1;
            
            // Reset camera
            camera.position.set(0, 10, 30);
            controls.target.set(0, 0, 0);
            
            // Update everything
            updateRoomColors();
            updateUI();
            createRoomList();
        }

        // Handle window resize
        function onWindowResize() {
            const canvas = document.getElementById('3d-viewer');
            const container = canvas.parentElement;
            
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
            
            // Rotate room labels to always face camera
            roomMeshes.forEach(mesh => {
                if (mesh.label) {
                    mesh.label.lookAt(camera.position);
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Location permission buttons
            allowLocationBtn.addEventListener('click', () => {
                hasLocationPermission = true;
                hideLocationPermission();
                
                // Try to get real location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            // Simulate starting from a random room based on location
                            const randomStart = Math.floor(Math.random() * 5) + 1;
                            goToRoom(randomStart);
                        },
                        error => {
                            console.log('Error getting location:', error);
                            // Start from main door anyway
                            goToRoom(1);
                        }
                    );
                } else {
                    goToRoom(1);
                }
            });
            
            denyLocationBtn.addEventListener('click', () => {
                hasLocationPermission = false;
                hideLocationPermission();
                goToRoom(1); // Start from main door
            });
            
            // Tour control buttons
            startTourBtn.addEventListener('click', startTour);
            pauseTourBtn.addEventListener('click', pauseTour);
            resetTourBtn.addEventListener('click', resetTour);
            
            // Keyboard controls for movement
            document.addEventListener('keydown', (event) => {
                const moveSpeed = 0.5;
                
                switch(event.key.toLowerCase()) {
                    case 'w': // Move forward
                        camera.position.z -= moveSpeed;
                        break;
                    case 's': // Move backward
                        camera.position.z += moveSpeed;
                        break;
                    case 'a': // Move left
                        camera.position.x -= moveSpeed;
                        break;
                    case 'd': // Move right
                        camera.position.x += moveSpeed;
                        break;
                    case ' ': // Space - jump to next room
                        const nextIndex = (currentRoomIndex + 1) % rooms.length;
                        goToRoom(rooms[nextIndex].id);
                        break;
                }
            });
        }

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>