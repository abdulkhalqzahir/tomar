<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نەخشەی 3Dی کۆلێژ - زانکۆی سەڵاحەدین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: pan-x pan-y;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, 'Noto Sans Arabic', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
            color: white;
            min-height: 100vh;
            direction: rtl;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(40, 53, 147, 0.95));
            backdrop-filter: blur(15px);
            border-bottom: 3px solid #4fc3f7;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
        }

        .title {
            flex: 1;
            margin-right: 12px;
        }

        .title h1 {
            font-size: 18px;
            margin-bottom: 2px;
            color: #e3f2fd;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .title h2 {
            font-size: 14px;
            color: #4fc3f7;
            font-weight: 600;
        }

        .location-indicator {
            background: rgba(79, 195, 247, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            border: 1px solid rgba(79, 195, 247, 0.4);
        }

        /* Main Content */
        .main-container {
            position: fixed;
            top: 70px;
            bottom: 80px;
            left: 0;
            right: 0;
            width: 100%;
        }

        #3d-viewer {
            width: 100%;
            height: 100%;
            display: block;
            background: linear-gradient(to bottom, #e3f2fd 0%, #bbdefb 100%);
        }

        /* Navigation Overlay */
        .navigation-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.9), rgba(40, 53, 147, 0.9));
            border-radius: 15px;
            padding: 15px;
            z-index: 500;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(79, 195, 247, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .nav-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-room {
            font-weight: bold;
            font-size: 18px;
            color: #4fc3f7;
        }

        .room-floor {
            background: rgba(79, 195, 247, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #4fc3f7;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #2196f3, #4fc3f7);
            border-radius: 10px;
            width: 5%;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(227, 242, 253, 0.8);
        }

        /* User Position Indicator */
        .user-position {
            position: absolute;
            width: 40px;
            height: 40px;
            z-index: 400;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .user-dot {
            width: 24px;
            height: 24px;
            background: #ff9800;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            left: 8px;
            box-shadow: 0 0 20px #ff9800, 0 0 40px rgba(255, 152, 0, 0.5);
            animation: pulse 2s infinite;
        }

        .user-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid #ff9800;
            position: absolute;
            top: -5px;
            left: 12px;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }

        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 15px;
            left: 15px;
            right: 15px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(40, 53, 147, 0.95));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 0 20px;
            z-index: 1000;
            border: 2px solid rgba(79, 195, 247, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #1976d2);
            border: 2px solid rgba(79, 195, 247, 0.3);
            color: #e3f2fd;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: scale(0.9);
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: white;
        }

        /* Room Info Panel */
        .room-info-panel {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.98), rgba(40, 53, 147, 0.98));
            backdrop-filter: blur(20px);
            border-radius: 25px 25px 0 0;
            padding: 25px 20px;
            z-index: 1500;
            transition: bottom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.6);
            border-top: 3px solid #4fc3f7;
            max-height: 70vh;
            overflow-y: auto;
        }

        .room-info-panel.open {
            bottom: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(79, 195, 247, 0.2);
        }

        .panel-title {
            font-size: 22px;
            color: #4fc3f7;
            font-weight: bold;
        }

        .close-panel {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(79, 195, 247, 0.1);
            border: none;
            color: #e3f2fd;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .room-details {
            margin-bottom: 25px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(79, 195, 247, 0.05);
            border-radius: 10px;
            border-right: 3px solid #4fc3f7;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 18px;
            color: #4fc3f7;
        }

        .detail-text {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: rgba(227, 242, 253, 0.6);
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #e3f2fd;
        }

        .direction-info {
            background: rgba(255, 152, 0, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .direction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #ff9800;
        }

        .direction-text {
            font-size: 14px;
            line-height: 1.5;
            color: #e3f2fd;
        }

        /* Touch Controls */
        .touch-controls {
            position: absolute;
            bottom: 90px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 300;
        }

        .joystick {
            position: absolute;
            width: 70px;
            height: 70px;
            background: rgba(26, 35, 126, 0.7);
            border-radius: 50%;
            border: 2px solid rgba(79, 195, 247, 0.3);
            top: 25px;
            left: 25px;
        }

        .joystick-handle {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(79, 195, 247, 0.8);
            border-radius: 50%;
            top: 15px;
            left: 15px;
            transition: transform 0.1s;
        }

        .touch-buttons {
            position: absolute;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(26, 35, 126, 0.7);
            border: 2px solid rgba(79, 195, 247, 0.3);
            color: #e3f2fd;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Path Indicators */
        .path-indicators {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .path-line {
            position: absolute;
            background: linear-gradient(to right, #4fc3f7, #2196f3);
            border-radius: 3px;
            opacity: 0.7;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .path-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #4fc3f7;
            opacity: 0.8;
        }

        /* Permission Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a237e, #283593);
            border-radius: 25px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 3px solid #4fc3f7;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        .modal-icon {
            font-size: 60px;
            color: #4fc3f7;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            color: #e3f2fd;
            margin-bottom: 15px;
        }

        .modal-text {
            color: rgba(227, 242, 253, 0.8);
            line-height: 1.6;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.allow {
            background: linear-gradient(to right, #2196f3, #4fc3f7);
            color: white;
        }

        .modal-btn.deny {
            background: rgba(227, 242, 253, 0.1);
            color: #e3f2fd;
            border: 2px solid rgba(227, 242, 253, 0.3);
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(40, 53, 147, 0.95));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            transform: translateY(-100px);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(79, 195, 247, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast-icon {
            font-size: 24px;
            color: #4fc3f7;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #e3f2fd;
        }

        .toast-text {
            font-size: 14px;
            color: rgba(227, 242, 253, 0.8);
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .mobile-header {
                height: 60px;
            }
            
            .logo {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .title h1 {
                font-size: 16px;
            }
            
            .title h2 {
                font-size: 12px;
            }
            
            .navigation-overlay {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
            }
            
            .mobile-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                height: 55px;
                padding: 0 15px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .room-info-panel {
                padding: 20px 15px;
            }
            
            .touch-controls {
                bottom: 80px;
                left: 15px;
                width: 100px;
                height: 100px;
            }
            
            .touch-buttons {
                bottom: 80px;
                right: 15px;
            }
            
            .touch-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Hide scrollbars but keep functionality */
        .room-info-panel::-webkit-scrollbar {
            width: 5px;
        }
        
        .room-info-panel::-webkit-scrollbar-thumb {
            background: rgba(79, 195, 247, 0.5);
            border-radius: 10px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a237e, #283593);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-icon {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(79, 195, 247, 0.2);
            border-top: 4px solid #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #4fc3f7;
            font-size: 18px;
            font-weight: bold;
        }

        /* Modern Building Elements */
        .floor-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(26, 35, 126, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 400;
            border: 2px solid rgba(79, 195, 247, 0.3);
        }

        .floor-btn {
            background: rgba(79, 195, 247, 0.2);
            border: none;
            color: #e3f2fd;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .floor-btn.active {
            background: #4fc3f7;
            color: white;
        }

        /* 3D Building Colors */
        .building-wall {
            background-color: #607d8b !important;
        }

        .building-window {
            background-color: #4fc3f7 !important;
        }

        .building-door {
            background-color: #795548 !important;
        }

        .ground-floor {
            background-color: #8d6e63 !important;
        }

        .first-floor {
            background-color: #78909c !important;
        }

        .second-floor {
            background-color: #546e7a !important;
        }

        .special-room {
            background-color: #ff9800 !important;
        }

        /* Interactive Elements */
        .interactive-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
            z-index: 200;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.8);
        }

        .interactive-dot:hover {
            transform: scale(1.5);
            background: #ff9800;
        }

        /* Building Structure Styles */
        .column {
            background-color: #37474f !important;
        }

        .staircase {
            background-color: #455a64 !important;
        }

        .elevator {
            background-color: #ff9800 !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon"></div>
        <div class="loading-text">دەستپێکردنی نەخشە...</div>
    </div>

    <!-- Permission Modal -->
    <div class="permission-modal" id="permissionModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h2 class="modal-title">بەخێربێیت بۆ نەخشەی 3Dی کۆلێژ!</h2>
            <p class="modal-text">بۆ ئەوەی بتوانین شوێنی ڕاستەقینەت نیشان بدەین و ڕێنمایی بکەین بۆ هۆڵەکان، پێویستە ڕێگە بدەیت بە بەکارهێنانی لۆکەیشن.</p>
            <div class="modal-buttons">
                <button class="modal-btn allow" id="allowLocation">
                    <i class="fas fa-check-circle"></i> ڕێگەدان بە لۆکەیشن
                </button>
                <button class="modal-btn deny" id="denyLocation">
                    <i class="fas fa-times-circle"></i> بەبێ لۆکەیشن بەردەوام بە
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">سەلام</div>
            <div class="toast-text" id="toastText">بەخێربێیت بۆ نەخشەی کۆلێژ</div>
        </div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="header-content">
            <div class="logo">س</div>
            <div class="title">
                <h1>زانکۆی سەڵاحەدین</h1>
                <h2>کۆلێژی بەڕێوەبردن و ئابووری</h2>
            </div>
            <div class="location-indicator" id="locationStatus">
                <i class="fas fa-map-marker-alt"></i>
                <span>لۆکەیشن...</span>
            </div>
        </div>
    </div>

    <!-- Main 3D Viewer -->
    <div class="main-container">
        <canvas id="3d-viewer"></canvas>
        
        <!-- Navigation Overlay -->
        <div class="navigation-overlay">
            <div class="nav-info">
                <div class="current-room" id="currentRoomName">دەرگای سەرەکی</div>
                <div class="room-floor" id="currentRoomFloor">نهۆمی سەرەتایی</div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="tourProgress"></div>
            </div>
            <div class="progress-text">
                <span>پێشکەوتن</span>
                <span id="progressPercent">5%</span>
            </div>
        </div>

        <!-- User Position Indicator -->
        <div class="user-position" id="userPosition" style="display: none;">
            <div class="user-arrow"></div>
            <div class="user-dot"></div>
        </div>

        <!-- Floor Indicator -->
        <div class="floor-indicator" id="floorIndicator">
            <button class="floor-btn active" data-floor="ground">س</button>
            <button class="floor-btn" data-floor="first">١</button>
            <button class="floor-btn" data-floor="second">٢</button>
            <span style="color: #4fc3f7; font-size: 12px;">نهۆم</span>
        </div>

        <!-- Touch Controls -->
        <div class="touch-controls" id="touchControls">
            <div class="joystick">
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>
        </div>

        <div class="touch-buttons">
            <div class="touch-btn" id="zoomInBtn">
                <i class="fas fa-plus"></i>
            </div>
            <div class="touch-btn" id="zoomOutBtn">
                <i class="fas fa-minus"></i>
            </div>
        </div>

        <!-- Path Indicators Container -->
        <div class="path-indicators" id="pathIndicators"></div>
    </div>

    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <button class="control-btn" id="prevRoomBtn">
            <i class="fas fa-arrow-right"></i>
        </button>
        <button class="control-btn active" id="autoTourBtn">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" id="infoBtn">
            <i class="fas fa-info"></i>
        </button>
        <button class="control-btn" id="nextRoomBtn">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Room Info Panel -->
    <div class="room-info-panel" id="roomInfoPanel">
        <div class="panel-header">
            <div class="panel-title">زانیاری هۆڵ</div>
            <button class="close-panel" id="closePanelBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="room-details" id="roomDetails">
            <!-- Room details will be loaded here -->
        </div>
        
        <div class="direction-info" id="directionInfo">
            <div class="direction-header">
                <i class="fas fa-directions"></i>
                <h3>ڕێنمایی بۆ ئەم هۆڵە</h3>
            </div>
            <p class="direction-text" id="directionText">لە شوێنی ئێستا، بە ڕاست بڕۆ بۆ گەیشتن بەم هۆڵە...</p>
        </div>
    </div>

    <script>
        // Enhanced Room data with detailed information based on the image
        const rooms = [
            { 
                id: 1, 
                name: "دەرگای سەرەکی", 
                floor: "ground", 
                x: 0, y: 0, z: 15,
                details: "دەرگای سەرەکی چوونە ناو کۆلێژەوە",
                description: "دەرگای سەرەکی کۆلێژ کە بۆ هەموو خوێندکاران و مامۆستایان کراوەیە",
                distance: 0,
                visited: true,
                current: true,
                color: 0x4CAF50,
                type: "entrance",
                capacity: "ناوچا",
                hours: "٨:٠٠ - ١٨:٠٠"
            },
            { 
                id: 2, 
                name: "ئەکاونتی", 
                floor: "first", 
                x: -8, y: 3.5, z: 10,
                details: "بەشی ئەکاونتی - نهۆمی یەکەم",
                description: "بەشی خوێندنی ئەکاونتی و هەموو وانەکانی تێدایە. لە لای ڕاستی پەیجی پلەیەکانە",
                distance: 15,
                color: 0x2196F3,
                type: "department",
                capacity: "٥٠٠ خوێندکار",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 3, 
                name: "ئابووری", 
                floor: "first", 
                x: 8, y: 3.5, z: 10,
                details: "بەشی ئابووری - نهۆمی یەکەم",
                description: "بەشی ئابووری و ئابووری نێودەوڵەتی. لە لای چەپی پەیجی پلەیەکانە",
                distance: 18,
                color: 0xFF9800,
                type: "department",
                capacity: "٤٥٠ خوێندکار",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 4, 
                name: "کتێبخانە", 
                floor: "ground", 
                x: -12, y: 0, z: 5,
                details: "کتێبخانەی کۆلێژ",
                description: "کتێبخانەی سەرەکی کۆلێژ بە هەزاران کتێب و سەرچاوە. لە لای ڕاستی دەرگای سەرەکیە",
                distance: 12,
                color: 0x9C27B0,
                type: "library",
                capacity: "٢٠٠ کورسی",
                hours: "٨:٠٠ - ٢٠:٠٠"
            },
            { 
                id: 5, 
                name: "موسڵمانان", 
                floor: "ground", 
                x: 12, y: 0, z: 0,
                details: "موسڵمانی نێرینە",
                description: "موسڵمانی کۆلێژ بۆ نوێژ و عیبادەت. لە نزیک تەوالێتی نێرینەیە",
                distance: 20,
                color: 0x795548,
                type: "prayer",
                capacity: "١٠٠ کەس",
                hours: "هەموو کات"
            },
            { 
                id: 6, 
                name: "تەوالێت", 
                floor: "ground", 
                x: 15, y: 0, z: -5,
                details: "تەوالێتی نێرینە",
                description: "تەوالێتی پاک و ئاسایی. لە نزیک موسڵمانە",
                distance: 22,
                color: 0x607D8B,
                type: "wc",
                capacity: "١٠ کەس",
                hours: "هەموو کات"
            },
            { 
                id: 7, 
                name: "تەوالێتی مێینە", 
                floor: "ground", 
                x: -15, y: 0, z: -5,
                details: "تەوالێتی مێینە",
                description: "تەوالێتی تایبەت بە خوێندکارە مێینەکان. لە لای چەپی کتێبخانەیە",
                distance: 25,
                color: 0xE91E63,
                type: "wc",
                capacity: "١٠ کەس",
                hours: "هەموو کات"
            },
            { 
                id: 8, 
                name: "وەرگرتنی خوێندکار", 
                floor: "ground", 
                x: -5, y: 0, z: -10,
                details: "بەشی وەرگرتنی خوێندکارە نوێیەکان",
                description: "بەشی وەرگرتنی خوێندکارانی نوێ و یارمەتیدانیان. لە نزیک کافێیە",
                distance: 18,
                color: 0x00BCD4,
                type: "admissions",
                capacity: "ژووری کۆبونەوە",
                hours: "٩:٠٠ - ١٤:٠٠"
            },
            { 
                id: 9, 
                name: "ئامادەبوون", 
                floor: "ground", 
                x: 5, y: 0, z: -10,
                details: "ئامادەبوونی خوێندکاران",
                description: "خشتەی ئامادەبوونی خوێندکاران و تۆمارکردن. لە نزیک دوکانیە",
                distance: 16,
                color: 0x8BC34A,
                type: "attendance",
                capacity: "ژووری کار",
                hours: "٨:٠٠ - ١٥:٠٠"
            },
            { 
                id: 10, 
                name: "پارێزەر", 
                floor: "ground", 
                x: 18, y: 0, z: 8,
                details: "پارێزەری کۆلێژ",
                description: "ژووری پارێزەر و پاراستنی کۆلێژ. لە نزیک دەرگای سەرەکیە",
                distance: 25,
                color: 0xF44336,
                type: "security",
                capacity: "ژووری کار",
                hours: "٢٤ کاتژمێر"
            },
            { 
                id: 11, 
                name: "پێشوازیکردن", 
                floor: "ground", 
                x: 0, y: 0, z: 12,
                details: "ژووری پێشوازیکردن",
                description: "ژووری پێشوازیکردن و یارمەتیدانی سەردانکەران. لە ناوەڕاستی دەرگای سەرەکیدایە",
                distance: 8,
                color: 0xFFC107,
                type: "reception",
                capacity: "ژووری چاوپێکەوتن",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 12, 
                name: "چاپ", 
                floor: "ground", 
                x: -18, y: 0, z: 8,
                details: "بەشی چاپکردن",
                description: "بەشی چاپکردنی پەڕە و پڕۆژەکان. لە لای چەپی کتێبخانەیە",
                distance: 28,
                color: 0x9E9E9E,
                type: "printing",
                capacity: "ژووری ئامێرەکان",
                hours: "٨:٠٠ - ١٥:٠٠"
            },
            { 
                id: 13, 
                name: "کافێ", 
                floor: "ground", 
                x: -10, y: 0, z: -12,
                details: "کافێی کۆلێژ",
                description: "کافێی خوێندکاران بۆ خواردن و خواردنەوە. لە نزیک وەرگرتنی خوێندکارە",
                distance: 22,
                color: 0xFF5722,
                type: "cafe",
                capacity: "١٠٠ کورسی",
                hours: "٨:٠٠ - ١٨:٠٠"
            },
            { 
                id: 14, 
                name: "دوکان", 
                floor: "ground", 
                x: 10, y: 0, z: -12,
                details: "دوکانی کۆلێژ",
                description: "دوکانی کۆلێژ بۆ کاڵای پێویست. لە نزیک ئامادەبوونە",
                distance: 20,
                color: 0x3F51B5,
                type: "shop",
                capacity: "دوکان",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 15, 
                name: "وەرزش", 
                floor: "ground", 
                x: 0, y: 0, z: -15,
                details: "بەشی وەرزشی",
                description: "بەشی وەرزش و تەندروستی. لە ناوەڕاستی کۆلێژە",
                distance: 18,
                color: 0x4CAF50,
                type: "sports",
                capacity: "ژووری وەرزش",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 16, 
                name: "مارکێتینگ", 
                floor: "ground", 
                x: -20, y: 0, z: -8,
                details: "بەشی مارکێتینگ",
                description: "بەشی مارکێتینگ و فرۆشتن. لە لای چەپی کۆلێژە",
                distance: 30,
                color: 0xE91E63,
                type: "department",
                capacity: "٣٠٠ خوێندکار",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 17, 
                name: "ئامار", 
                floor: "second", 
                x: -8, y: 7, z: 10,
                details: "بەشی ئامار - نهۆمی دووەم",
                description: "بەشی ئامار و زانستی داتا. لەسەر هەمان شوێنی ئەکاونتیە بەڵام لەسەر نهۆمی دووەم",
                distance: 35,
                color: 0x673AB7,
                type: "department",
                capacity: "٤٠٠ خوێندکار",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 18, 
                name: "دارایی و بانکداری", 
                floor: "second", 
                x: 8, y: 7, z: 10,
                details: "بەشی دارایی و بانکداری - نهۆمی دووەم",
                description: "بەشی دارایی و بانکداری و بوودجە. لەسەر هەمان شوێنی ئابووریە بەڵام لەسەر نهۆمی دووەم",
                distance: 38,
                color: 0x009688,
                type: "department",
                capacity: "٣٥٠ خوێندکار",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 19, 
                name: "دەزگای کۆلێژ", 
                floor: "second", 
                x: 0, y: 7, z: 0,
                details: "دەزگای کۆلێژ - نهۆمی دووەم",
                description: "ژووری دەزگای کۆلێژ و بەڕێوەبردن. لە ناوەڕاستی نهۆمی دووەمە",
                distance: 42,
                color: 0xFF9800,
                type: "dean",
                capacity: "ژووری کۆبونەوە",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 20, 
                name: "یەکەکانی ئەکاونتی", 
                floor: "second", 
                x: -12, y: 7, z: 5,
                details: "یەکەکانی بەشی ئەکاونتی - نهۆمی دووەم",
                description: "یەکەکانی تایبەتی بەشی ئەکاونتی. لە نزیک بەشی ئامارە",
                distance: 40,
                color: 0x2196F3,
                type: "units",
                capacity: "ژووری وانە",
                hours: "٨:٠٠ - ١٦:٠٠"
            },
            { 
                id: 21, 
                name: "هۆڵی د. بەیان", 
                floor: "second", 
                x: 12, y: 7, z: 5,
                details: "هۆڵی دکتۆر بەیان - نهۆمی دووەم",
                description: "هۆڵی وانەی گەورە بە ناوی دکتۆر بەیان. بۆ کۆرسە گەورەکان",
                distance: 38,
                color: 0xFF5722,
                type: "hall",
                capacity: "٢٠٠ کورسی",
                hours: "بەپێی پڕۆگرامی وانە"
            },
            { 
                id: 22, 
                name: "هۆڵی شەهید گەرەداغی", 
                floor: "first", 
                x: -10, y: 3.5, z: -5,
                details: "هۆڵی شەهید گەرەداغی - نهۆمی یەکەم",
                description: "هۆڵی وانەی گەورە بە ناوی شەهید گەرەداغی. لە لای ڕاستی پەیجی پلەیەکانە",
                distance: 28,
                color: 0x4CAF50,
                type: "hall",
                capacity: "١٥٠ کورسی",
                hours: "بەپێی پڕۆگرامی وانە"
            },
            { 
                id: 23, 
                name: "هۆڵی ئاشتی", 
                floor: "first", 
                x: 10, y: 3.5, z: -5,
                details: "هۆڵی ئاشتی - نهۆمی یەکەم",
                description: "هۆڵی وانەی گەورە بە ناوی ئاشتی. لە لای چەپی پەیجی پلەیەکانە",
                distance: 26,
                color: 0x9C27B0,
                type: "hall",
                capacity: "١٨٠ کورسی",
                hours: "بەپێی پڕۆگرامی وانە"
            },
            { 
                id: 24, 
                name: "یەکێتی خوێندکاران", 
                floor: "first", 
                x: 0, y: 3.5, z: -5,
                details: "یەکێتی خوێندکاران - نهۆمی یەکەم",
                description: "ژووری یەکێتی خوێندکاران و چالاکیەکان. لە ناوەڕاستی نهۆمی یەکەمە",
                distance: 20,
                color: 0x00BCD4,
                type: "union",
                capacity: "ژووری کۆبونەوە",
                hours: "٩:٠٠ - ١٥:٠٠"
            }
        ];

        // Path connections between rooms (for navigation guidance)
        const roomConnections = [
            { from: 1, to: 11, color: 0x4fc3f7 }, // Main door to reception
            { from: 11, to: 4, color: 0x4fc3f7 }, // Reception to library
            { from: 11, to: 12, color: 0x4fc3f7 }, // Reception to printing
            { from: 1, to: 5, color: 0xff9800 }, // Main door to mosque
            { from: 5, to: 6, color: 0xff9800 }, // Mosque to WC male
            { from: 4, to: 7, color: 0xff9800 }, // Library to WC female
            { from: 1, to: 10, color: 0x4caf50 }, // Main door to security
            { from: 11, to: 8, color: 0x2196f3 }, // Reception to admissions
            { from: 8, to: 13, color: 0x2196f3 }, // Admissions to cafe
            { from: 11, to: 9, color: 0x9c27b0 }, // Reception to attendance
            { from: 9, to: 14, color: 0x9c27b0 }, // Attendance to shop
            { from: 8, to: 15, color: 0xff5722 }, // Cafe to sports
            { from: 9, to: 15, color: 0xff5722 }, // Shop to sports
            { from: 4, to: 16, color: 0xe91e63 }, // Library to marketing
            // Stair connections
            { from: 2, to: 17, color: 0x673ab7, type: "stair" }, // Accounting to Statistics
            { from: 3, to: 18, color: 0x009688, type: "stair" }, // Economics to Finance
            { from: 22, to: 19, color: 0xff9800, type: "stair" }, // Garadaghi Hall to Dean
            { from: 23, to: 21, color: 0xff5722, type: "stair" }, // Ashti Hall to Dr. Bayan Hall
            { from: 24, to: 20, color: 0x2196f3, type: "stair" }  // Union to Accounting Units
        ];

        // Global variables
        let scene, camera, renderer, controls;
        let roomMeshes = [];
        let currentRoomIndex = 0;
        let isAutoTour = false;
        let tourInterval;
        let userPosition = { x: 0, y: 0, z: 15 };
        let userFloor = "ground";
        let hasLocationPermission = false;
        let visitedRooms = 1;
        let isMoving = false;
        let joystickActive = false;
        let joystickPosition = { x: 0, y: 0 };
        let currentFloor = "ground";
        let pathLines = [];

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const permissionModal = document.getElementById('permissionModal');
        const allowLocationBtn = document.getElementById('allowLocation');
        const denyLocationBtn = document.getElementById('denyLocation');
        const locationStatus = document.getElementById('locationStatus');
        const currentRoomName = document.getElementById('currentRoomName');
        const currentRoomFloor = document.getElementById('currentRoomFloor');
        const tourProgress = document.getElementById('tourProgress');
        const progressPercent = document.getElementById('progressPercent');
        const userPositionEl = document.getElementById('userPosition');
        const prevRoomBtn = document.getElementById('prevRoomBtn');
        const nextRoomBtn = document.getElementById('nextRoomBtn');
        const autoTourBtn = document.getElementById('autoTourBtn');
        const infoBtn = document.getElementById('infoBtn');
        const roomInfoPanel = document.getElementById('roomInfoPanel');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const roomDetails = document.getElementById('roomDetails');
        const directionText = document.getElementById('directionText');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastText = document.getElementById('toastText');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const joystickHandle = document.getElementById('joystickHandle');
        const touchControls = document.getElementById('touchControls');
        const floorIndicator = document.getElementById('floorIndicator');
        const floorButtons = document.querySelectorAll('.floor-btn');
        const pathIndicators = document.getElementById('pathIndicators');

        // Initialize the application
        function init() {
            // Setup event listeners first
            setupEventListeners();
            
            // Initialize 3D scene
            init3DScene();
            
            // Create path indicators
            createPathIndicators();
            
            // Hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                // Show permission modal after loading
                setTimeout(() => {
                    permissionModal.style.display = 'flex';
                }, 500);
            }, 1500);
            
            // Update UI
            updateUI();
            
            // Start animation loop
            animate();
        }

        // Initialize 3D scene with modern architecture
        function init3DScene() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe3f2fd);
            scene.fog = new THREE.Fog(0xe3f2fd, 10, 100);
            
            // Create camera
            const canvas = document.getElementById('3d-viewer');
            const width = canvas.parentElement.clientWidth;
            const height = canvas.parentElement.clientHeight;
            
            camera = new THREE.PerspectiveCamera(70, width / height, 0.1, 1000);
            camera.position.set(0, 25, 35);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.enablePan = false;
            controls.minDistance = 5;
            controls.maxDistance = 100;
            controls.maxPolarAngle = Math.PI / 2;
            
            // Add enhanced lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 30, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);
            
            // Create modern building
            createModernBuilding();
            
            // Create rooms
            createRooms();
            
            // Create environment
            createEnvironment();
            
            // Create user position indicator
            createUserIndicator();
            
            // Create stairs between floors
            createStairs();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Handle touch controls
            setupTouchControls();
        }

        // Create modern building structure
        function createModernBuilding() {
            // Main building structure - Modern design
            const buildingGroup = new THREE.Group();
            
            // Ground floor base
            const groundGeometry = new THREE.BoxGeometry(60, 0.5, 40);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x78909c,
                transparent: true,
                opacity: 0.9
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.position.y = 0;
            ground.receiveShadow = true;
            buildingGroup.add(ground);
            
            // Building walls
            const wallGeometry = new THREE.BoxGeometry(50, 12, 30);
            const wallMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x607d8b,
                transparent: true,
                opacity: 0.8
            });
            const walls = new THREE.Mesh(wallGeometry, wallMaterial);
            walls.position.y = 6;
            walls.castShadow = true;
            walls.receiveShadow = true;
            buildingGroup.add(walls);
            
            // Modern windows
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 3; j++) {
                    const windowGeometry = new THREE.BoxGeometry(2, 3, 0.1);
                    const windowMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x4fc3f7,
                        transparent: true,
                        opacity: 0.7
                    });
                    const window = new THREE.Mesh(windowGeometry, windowMaterial);
                    window.position.set(
                        -20 + i * 13,
                        3 + j * 4,
                        15
                    );
                    buildingGroup.add(window);
                    
                    // Window frame
                    const frameGeometry = new THREE.BoxGeometry(2.2, 3.2, 0.2);
                    const frameMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x37474f
                    });
                    const frame = new THREE.Mesh(frameGeometry, frameMaterial);
                    frame.position.copy(window.position);
                    frame.position.z += 0.05;
                    buildingGroup.add(frame);
                }
            }
            
            // Main entrance
            const entranceGeometry = new THREE.BoxGeometry(8, 6, 1);
            const entranceMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x4fc3f7
            });
            const entrance = new THREE.Mesh(entranceGeometry, entranceMaterial);
            entrance.position.set(0, 3, 15.5);
            entrance.castShadow = true;
            buildingGroup.add(entrance);
            
            // Entrance door
            const doorGeometry = new THREE.BoxGeometry(3, 5, 0.5);
            const doorMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x795548
            });
            const door = new THREE.Mesh(doorGeometry, doorMaterial);
            door.position.set(0, 2.5, 16);
            door.castShadow = true;
            buildingGroup.add(door);
            
            // Add building to scene
            scene.add(buildingGroup);
            
            // Parking area
            const parkingGeometry = new THREE.BoxGeometry(20, 0.2, 15);
            const parkingMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x78909c
            });
            const parking = new THREE.Mesh(parkingGeometry, parkingMaterial);
            parking.position.set(25, 0.1, 5);
            parking.receiveShadow = true;
            scene.add(parking);
            
            // Car models (simplified)
            for (let i = 0; i < 3; i++) {
                const carGeometry = new THREE.BoxGeometry(3, 1, 1.5);
                const carMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xf44336
                });
                const car = new THREE.Mesh(carGeometry, carMaterial);
                car.position.set(25, 0.6, 2 + i * 4);
                car.rotation.y = Math.PI / 2;
                car.castShadow = true;
                scene.add(car);
            }
            
            // Courtyard
            const courtyardGeometry = new THREE.CircleGeometry(15, 32);
            const courtyardMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8bc34a
            });
            const courtyard = new THREE.Mesh(courtyardGeometry, courtyardMaterial);
            courtyard.rotation.x = -Math.PI / 2;
            courtyard.position.set(0, 0.05, 0);
            courtyard.receiveShadow = true;
            scene.add(courtyard);
            
            // Courtyard path
            const pathGeometry = new THREE.BoxGeometry(4, 0.1, 30);
            const pathMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x78909c
            });
            const path = new THREE.Mesh(pathGeometry, pathMaterial);
            path.position.set(0, 0.1, 0);
            path.receiveShadow = true;
            scene.add(path);
        }

        // Create stairs between floors
        function createStairs() {
            // Main staircase
            for (let i = 0; i < 20; i++) {
                const stepGeometry = new THREE.BoxGeometry(3, 0.2, 0.5);
                const stepMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x795548
                });
                const step = new THREE.Mesh(stepGeometry, stepMaterial);
                step.position.set(0, i * 0.2, 12);
                step.castShadow = true;
                step.receiveShadow = true;
                scene.add(step);
            }
            
            // Staircase structure
            const stairStructureGeometry = new THREE.BoxGeometry(4, 4, 1);
            const stairStructureMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x607d8b
            });
            const stairStructure = new THREE.Mesh(stairStructureGeometry, stairStructureMaterial);
            stairStructure.position.set(0, 2, 12.5);
            stairStructure.castShadow = true;
            scene.add(stairStructure);
            
            // Elevator
            const elevatorGeometry = new THREE.BoxGeometry(2, 12, 2);
            const elevatorMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xff9800
            });
            const elevator = new THREE.Mesh(elevatorGeometry, elevatorMaterial);
            elevator.position.set(5, 6, 12);
            elevator.castShadow = true;
            scene.add(elevator);
        }

        // Create environment elements
        function createEnvironment() {
            // Trees in courtyard
            for (let i = 0; i < 6; i++) {
                const treeGroup = new THREE.Group();
                
                // Tree trunk
                const trunkGeometry = new THREE.CylinderGeometry(0.3, 0.5, 3, 8);
                const trunkMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x795548
                });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.y = 1.5;
                trunk.castShadow = true;
                treeGroup.add(trunk);
                
                // Tree leaves
                const leavesGeometry = new THREE.SphereGeometry(1.5, 8, 6);
                const leavesMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x4CAF50
                });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.y = 3.5;
                leaves.castShadow = true;
                treeGroup.add(leaves);
                
                // Position trees in circle
                const angle = (i / 6) * Math.PI * 2;
                const radius = 12;
                treeGroup.position.set(
                    Math.cos(angle) * radius,
                    0,
                    Math.sin(angle) * radius
                );
                scene.add(treeGroup);
            }
            
            // Benches in courtyard
            for (let i = 0; i < 4; i++) {
                const benchGroup = new THREE.Group();
                
                // Bench seat
                const seatGeometry = new THREE.BoxGeometry(3, 0.2, 0.5);
                const seatMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x795548
                });
                const seat = new THREE.Mesh(seatGeometry, seatMaterial);
                seat.position.y = 0.5;
                seat.castShadow = true;
                benchGroup.add(seat);
                
                // Bench legs
                for (let j = 0; j < 2; j++) {
                    const legGeometry = new THREE.BoxGeometry(0.1, 0.5, 0.1);
                    const legMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0x795548
                    });
                    const leg = new THREE.Mesh(legGeometry, legMaterial);
                    leg.position.set(-1.2 + j * 2.4, 0.25, 0);
                    leg.castShadow = true;
                    benchGroup.add(leg);
                }
                
                // Position benches
                const angle = (i / 4) * Math.PI * 2 + Math.PI/4;
                const radius = 10;
                benchGroup.position.set(
                    Math.cos(angle) * radius,
                    0,
                    Math.sin(angle) * radius
                );
                benchGroup.rotation.y = angle + Math.PI/2;
                scene.add(benchGroup);
            }
        }

        // Create rooms with modern styling
        function createRooms() {
            rooms.forEach((room, index) => {
                // Room size based on type
                let size = 4;
                if (room.type === "hall") size = 6;
                if (room.type === "department") size = 8;
                if (room.type === "library") size = 10;
                
                const roomGeometry = new THREE.BoxGeometry(size, 3, size);
                
                // Use room's color from data
                const roomMaterial = new THREE.MeshLambertMaterial({ 
                    color: room.color,
                    transparent: true,
                    opacity: 0.8
                });
                const roomMesh = new THREE.Mesh(roomGeometry, roomMaterial);
                
                // Position the room
                roomMesh.position.set(room.x, room.y + 1.5, room.z);
                roomMesh.castShadow = true;
                roomMesh.receiveShadow = true;
                
                // Add room door
                const doorGeometry = new THREE.BoxGeometry(1.5, 2.5, 0.3);
                const doorMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x795548
                });
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                door.position.set(room.x, room.y + 1.25, room.z + size/2);
                door.castShadow = true;
                scene.add(door);
                
                // Add modern label with room info
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 100;
                
                // Modern gradient background
                const gradient = context.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                gradient.addColorStop(1, 'rgba(227, 242, 253, 0.9)');
                context.fillStyle = gradient;
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Modern border
                context.strokeStyle = '#4fc3f7';
                context.lineWidth = 2;
                context.strokeRect(5, 5, canvas.width-10, canvas.height-10);
                
                // Room name with shadow
                context.shadowColor = 'rgba(0, 0, 0, 0.3)';
                context.shadowBlur = 5;
                context.shadowOffsetX = 2;
                context.shadowOffsetY = 2;
                
                context.fillStyle = '#1a237e';
                context.font = 'bold 20px Arial';
                context.textAlign = 'center';
                context.fillText(room.name, canvas.width/2, 35);
                
                context.shadowColor = 'transparent';
                context.fillStyle = '#283593';
                context.font = '14px Arial';
                context.fillText(room.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                               room.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم', 
                               canvas.width/2, 60);
                
                // Room type indicator
                context.fillStyle = '#4fc3f7';
                context.font = '12px Arial';
                const typeText = room.type === "department" ? "بەش" :
                               room.type === "hall" ? "هۆڵ" :
                               room.type === "library" ? "کتێبخانە" :
                               room.type === "wc" ? "تەوالێت" :
                               room.type === "cafe" ? "کافێ" : "ژووری";
                context.fillText(typeText, canvas.width/2, 80);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true
                });
                const label = new THREE.Sprite(labelMaterial);
                label.position.set(room.x, room.y + 4, room.z);
                label.scale.set(8, 2.7, 1);
                
                // Store reference
                roomMesh.roomData = room;
                roomMesh.label = label;
                roomMesh.door = door;
                
                scene.add(roomMesh);
                scene.add(label);
                roomMeshes.push(roomMesh);
            });
        }

        // Create path indicators for navigation
        function createPathIndicators() {
            roomConnections.forEach(connection => {
                const fromRoom = rooms.find(r => r.id === connection.from);
                const toRoom = rooms.find(r => r.id === connection.to);
                
                if (!fromRoom || !toRoom) return;
                
                // Create 3D path line
                const points = [
                    new THREE.Vector3(fromRoom.x, fromRoom.y + 1, fromRoom.z),
                    new THREE.Vector3(toRoom.x, toRoom.y + 1, toRoom.z)
                ];
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ 
                    color: connection.color,
                    linewidth: 2,
                    transparent: true,
                    opacity: 0.6
                });
                
                const line = new THREE.Line(geometry, material);
                scene.add(line);
                pathLines.push(line);
                
                // Add 2D overlay indicator
                const pathIndicator = document.createElement('div');
                pathIndicator.className = 'path-line';
                pathIndicator.style.backgroundColor = `rgb(${(connection.color >> 16) & 255}, ${(connection.color >> 8) & 255}, ${connection.color & 255})`;
                
                // Calculate position and rotation for 2D indicator
                const viewer = document.getElementById('3d-viewer');
                const width = viewer.clientWidth;
                const height = viewer.clientHeight;
                
                const screenFromX = (fromRoom.x + 30) / 60 * width;
                const screenFromY = (fromRoom.z + 20) / 40 * height;
                const screenToX = (toRoom.x + 30) / 60 * width;
                const screenToY = (toRoom.z + 20) / 40 * height;
                
                const dx = screenToX - screenFromX;
                const dy = screenToY - screenFromY;
                const length = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                pathIndicator.style.width = `${length}px`;
                pathIndicator.style.height = '6px';
                pathIndicator.style.left = `${screenFromX}px`;
                pathIndicator.style.top = `${screenFromY - 3}px`;
                pathIndicator.style.transform = `rotate(${angle}deg)`;
                pathIndicator.style.transformOrigin = '0 0';
                
                pathIndicators.appendChild(pathIndicator);
                
                // Add arrow at the end
                const arrow = document.createElement('div');
                arrow.className = 'path-arrow';
                arrow.style.borderTopColor = `rgb(${(connection.color >> 16) & 255}, ${(connection.color >> 8) & 255}, ${connection.color & 255})`;
                arrow.style.left = `${screenToX - 8}px`;
                arrow.style.top = `${screenToY - 6}px`;
                arrow.style.transform = `rotate(${angle}deg)`;
                
                pathIndicators.appendChild(arrow);
            });
        }

        // Create user position indicator
        function createUserIndicator() {
            // Create a 3D indicator for the user
            const geometry = new THREE.SphereGeometry(0.5, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xff9800,
                transparent: true,
                opacity: 0.9
            });
            const userSphere = new THREE.Mesh(geometry, material);
            userSphere.position.set(userPosition.x, userPosition.y + 1.5, userPosition.z);
            scene.add(userSphere);
            
            // Add a cone for direction
            const coneGeometry = new THREE.ConeGeometry(0.3, 1, 8);
            const coneMaterial = new THREE.MeshBasicMaterial({ color: 0xff9800 });
            const directionCone = new THREE.Mesh(coneGeometry, coneMaterial);
            directionCone.position.set(userPosition.x, userPosition.y + 2.5, userPosition.z);
            directionCone.rotation.x = Math.PI;
            scene.add(directionCone);
            
            // Store references
            window.userIndicator = userSphere;
            window.directionIndicator = directionCone;
        }

        // Update user position
        function updateUserPosition(x, y, z) {
            userPosition = { x, y, z };
            
            // Update 3D indicator
            if (window.userIndicator && window.directionIndicator) {
                window.userIndicator.position.set(x, y + 1.5, z);
                window.directionIndicator.position.set(x, y + 2.5, z);
            }
            
            // Update 2D overlay indicator
            updateUserPositionOverlay(x, z);
            
            // Update current floor based on y position
            if (y < 1.5) userFloor = "ground";
            else if (y < 4.5) userFloor = "first";
            else userFloor = "second";
            
            // Update floor buttons
            updateFloorButtons();
            
            // Check if user is near any room
            checkUserNearRooms();
        }

        // Update 2D overlay indicator position
        function updateUserPositionOverlay(x, z) {
            const viewer = document.getElementById('3d-viewer');
            const width = viewer.clientWidth;
            const height = viewer.clientHeight;
            
            // Convert 3D coordinates to screen coordinates
            const screenX = (x + 30) / 60 * width;
            const screenY = (z + 20) / 40 * height;
            
            userPositionEl.style.left = `${screenX - 20}px`;
            userPositionEl.style.top = `${screenY - 20}px`;
            userPositionEl.style.display = 'block';
        }

        // Update floor buttons state
        function updateFloorButtons() {
            floorButtons.forEach(btn => {
                const floor = btn.dataset.floor;
                btn.classList.toggle('active', floor === userFloor);
            });
            currentFloor = userFloor;
        }

        // Check if user is near any rooms
        function checkUserNearRooms() {
            rooms.forEach((room, index) => {
                const dx = room.x - userPosition.x;
                const dz = room.z - userPosition.z;
                const dy = room.y - userPosition.y;
                const distance = Math.sqrt(dx*dx + dz*dz + dy*dy);
                
                // If user is close to a room and it's on the same floor
                if (distance < 3 && room.floor === userFloor && !room.visited) {
                    // Mark as visited
                    room.visited = true;
                    visitedRooms++;
                    
                    // Update room color
                    updateRoomColor(index);
                    
                    // Show notification
                    showToast("هۆڵی نوێ", `سەردانی ${room.name} کرایەوە`);
                    
                    // Update progress
                    updateProgress();
                    
                    // Update UI
                    updateUI();
                }
            });
        }

        // Update room color
        function updateRoomColor(index) {
            const room = rooms[index];
            const roomMesh = roomMeshes[index];
            
            if (!roomMesh) return;
            
            // If visited, make it brighter
            if (room.visited) {
                roomMesh.material.color.setHex(room.color);
                roomMesh.material.opacity = 1;
            } else {
                roomMesh.material.color.setHex(room.color);
                roomMesh.material.opacity = 0.6;
            }
        }

        // Go to specific room
        function goToRoom(roomId) {
            const roomIndex = rooms.findIndex(r => r.id === roomId);
            if (roomIndex === -1) return;
            
            // Mark as visited
            if (!rooms[roomIndex].visited) {
                rooms[roomIndex].visited = true;
                visitedRooms++;
            }
            
            // Update current room
            rooms.forEach(room => room.current = false);
            rooms[roomIndex].current = true;
            currentRoomIndex = roomIndex;
            
            // Move user to this room
            const targetRoom = rooms[roomIndex];
            updateUserPosition(targetRoom.x, targetRoom.y, targetRoom.z);
            
            // Update all room colors
            rooms.forEach((room, index) => {
                updateRoomColor(index);
            });
            
            // Update UI
            updateUI();
            
            // Update room info if panel is open
            if (roomInfoPanel.classList.contains('open')) {
                loadRoomDetails();
            }
            
            // Show direction info
            updateDirectionInfo();
            
            // Show notification
            showToast("گواستنەوە", `گواسترایتەوە بۆ ${targetRoom.name}`);
        }

        // Go to next room
        function nextRoom() {
            const nextIndex = (currentRoomIndex + 1) % rooms.length;
            goToRoom(rooms[nextIndex].id);
        }

        // Go to previous room
        function prevRoom() {
            const prevIndex = (currentRoomIndex - 1 + rooms.length) % rooms.length;
            goToRoom(rooms[prevIndex].id);
        }

        // Start/stop auto tour
        function toggleAutoTour() {
            isAutoTour = !isAutoTour;
            
            if (isAutoTour) {
                autoTourBtn.classList.add('active');
                autoTourBtn.innerHTML = '<i class="fas fa-pause"></i>';
                
                // Start tour
                let roomIndex = 0;
                tourInterval = setInterval(() => {
                    goToRoom(rooms[roomIndex].id);
                    roomIndex = (roomIndex + 1) % rooms.length;
                    
                    // Stop if all rooms visited
                    if (roomIndex === 0) {
                        toggleAutoTour();
                        showToast("سەردانی تەواو", "هەموو هۆڵەکان سەردان کران!");
                    }
                }, 3000);
            } else {
                autoTourBtn.classList.remove('active');
                autoTourBtn.innerHTML = '<i class="fas fa-play"></i>';
                
                // Stop tour
                if (tourInterval) {
                    clearInterval(tourInterval);
                }
            }
        }

        // Update UI
        function updateUI() {
            const currentRoom = rooms[currentRoomIndex];
            const visitedCount = rooms.filter(r => r.visited).length;
            const totalRooms = rooms.length;
            const percentage = Math.round((visitedCount / totalRooms) * 100);
            
            currentRoomName.textContent = currentRoom.name;
            currentRoomFloor.textContent = currentRoom.floor === 'ground' ? 'نهۆمی سەرەتایی' : 
                                          currentRoom.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم';
            
            tourProgress.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
            
            // Update location status
            if (hasLocationPermission) {
                locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span>لۆکەیشن چالاکە</span>`;
                locationStatus.style.background = "rgba(76, 175, 80, 0.2)";
                locationStatus.style.borderColor = "rgba(76, 175, 80, 0.4)";
            } else {
                locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span>لۆکەیشن ناچالاکە</span>`;
                locationStatus.style.background = "rgba(255, 152, 0, 0.2)";
                locationStatus.style.borderColor = "rgba(255, 152, 0, 0.4)";
            }
        }

        // Update progress
        function updateProgress() {
            const visitedCount = rooms.filter(r => r.visited).length;
            const totalRooms = rooms.length;
            const percentage = Math.round((visitedCount / totalRooms) * 100);
            
            tourProgress.style.width = `${percentage}%`;
            progressPercent.textContent = `${percentage}%`;
        }

        // Load room details into panel
        function loadRoomDetails() {
            const currentRoom = rooms[currentRoomIndex];
            
            // Get room type in Kurdish
            const roomType = currentRoom.type === "department" ? "بەش" :
                           currentRoom.type === "hall" ? "هۆڵی وانە" :
                           currentRoom.type === "library" ? "کتێبخانە" :
                           currentRoom.type === "wc" ? "تەوالێت" :
                           currentRoom.type === "cafe" ? "کافێ" :
                           currentRoom.type === "shop" ? "دوکان" :
                           currentRoom.type === "security" ? "پارێزەری" :
                           currentRoom.type === "reception" ? "پێشوازی" :
                           currentRoom.type === "prayer" ? "موسڵمان" :
                           currentRoom.type === "sports" ? "وەرزشی" :
                           currentRoom.type === "admissions" ? "وەرگرتنی خوێندکار" :
                           currentRoom.type === "attendance" ? "ئامادەبوون" :
                           currentRoom.type === "printing" ? "چاپ" :
                           currentRoom.type === "dean" ? "دەزگای کۆلێژ" :
                           currentRoom.type === "units" ? "یەکەی ئەکاونتی" :
                           currentRoom.type === "union" ? "یەکێتی خوێندکاران" :
                           currentRoom.type === "entrance" ? "دەرگای سەرەکی" : "ژووری";
            
            roomDetails.innerHTML = `
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">ناوی هۆڵ</div>
                        <div class="detail-value">${currentRoom.name}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">نهۆم</div>
                        <div class="detail-value">${currentRoom.floor === 'ground' ? 'سەرەتایی' : 
                                                   currentRoom.floor === 'first' ? 'یەکەم' : 'دووەم'}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-tag"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">جۆری هۆڵ</div>
                        <div class="detail-value">${roomType}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">زانیاری</div>
                        <div class="detail-value">${currentRoom.details}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-road"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">دووری لە دەرگای سەرەکی</div>
                        <div class="detail-value">${currentRoom.distance} مەتر</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">توانای هۆڵ</div>
                        <div class="detail-value">${currentRoom.capacity}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">کاتی کراوەیی</div>
                        <div class="detail-value">${currentRoom.hours}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="detail-text">
                        <div class="detail-label">وەسفی تەواو</div>
                        <div class="detail-value">${currentRoom.description}</div>
                    </div>
                </div>
            `;
            
            updateDirectionInfo();
        }

        // Update direction information
        function updateDirectionInfo() {
            const currentRoom = rooms[currentRoomIndex];
            
            let direction = "";
            
            if (currentRoom.id === 1) {
                direction = "ئێستا لە دەرگای سەرەکیدایت. بۆ چوونە ناوەوە، بە ڕاست بڕۆ بۆ ژووری پێشوازیکردن.";
            } else if (currentRoom.floor !== userFloor) {
                direction = `بۆ گەیشتن بەم هۆڵە، پێویستە بچیتە سەر ${currentRoom.floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم'}. پەیجی پلەیەکان لە ناوەڕاستی کۆلێژە (نیشانە کراوە بە هێڵی شین).`;
            } else {
                const dx = currentRoom.x - userPosition.x;
                const dz = currentRoom.z - userPosition.z;
                
                if (Math.abs(dx) > Math.abs(dz)) {
                    direction = dx > 0 ? "بۆ گەیشتن بەم هۆڵە، بە ڕاست بڕۆ" : "بۆ گەیشتن بەم هۆڵە، بە چەپ بڕۆ";
                } else {
                    direction = dz > 0 ? "بۆ گەیشتن بەم هۆڵە، بە پێشەوە بڕۆ" : "بۆ گەیشتن بەم هۆڵە، بە دواوە بڕۆ";
                }
                
                // Find nearest connection path color
                const connection = roomConnections.find(conn => 
                    conn.from === currentRoom.id || conn.to === currentRoom.id
                );
                
                if (connection) {
                    const colorName = connection.color === 0x4fc3f7 ? "شین" :
                                    connection.color === 0xff9800 ? "پەمەیی" :
                                    connection.color === 0x4caf50 ? "سەوز" :
                                    connection.color === 0x2196f3 ? "شینی تۆخ" :
                                    connection.color === 0x9c27b0 ? "مۆر" :
                                    connection.color === 0xff5722 ? "پەمەیی تۆخ" :
                                    connection.color === 0xe91e63 ? "پەمەیی سوور" :
                                    connection.color === 0x673ab7 ? "پەمەیی تۆخ" :
                                    connection.color === 0x009688 ? "سەوزی تۆخ" : "ڕەش";
                    
                    direction += `. هێڵی ${colorName} ڕێگاکەت نیشان دەدات.`;
                }
                
                direction += ` دووری نزیکەی ${currentRoom.distance} مەترە لە دەرگای سەرەکی.`;
            }
            
            directionText.textContent = direction;
        }

        // Show/hide room info panel
        function toggleRoomInfoPanel() {
            if (roomInfoPanel.classList.contains('open')) {
                roomInfoPanel.classList.remove('open');
            } else {
                roomInfoPanel.classList.add('open');
                loadRoomDetails();
            }
        }

        // Show toast notification
        function showToast(title, message) {
            toastTitle.textContent = title;
            toastText.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Setup touch controls for movement
        function setupTouchControls() {
            const joystick = document.querySelector('.joystick');
            let touchId = null;
            
            // Touch events for joystick
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchId = e.changedTouches[0].identifier;
                joystickActive = true;
            });
            
            joystick.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                
                e.preventDefault();
                const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
                if (!touch) return;
                
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const deltaX = touch.clientX - centerX;
                const deltaY = touch.clientY - centerY;
                
                // Limit joystick movement
                const distance = Math.min(Math.sqrt(deltaX*deltaX + deltaY*deltaY), 35);
                const angle = Math.atan2(deltaY, deltaX);
                
                joystickPosition.x = Math.cos(angle) * distance;
                joystickPosition.y = Math.sin(angle) * distance;
                
                // Update joystick handle position
                joystickHandle.style.transform = `translate(${joystickPosition.x}px, ${joystickPosition.y}px)`;
                
                // Move user based on joystick
                moveUser(joystickPosition.x / 35, -joystickPosition.y / 35);
            });
            
            joystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickPosition = { x: 0, y: 0 };
                joystickHandle.style.transform = 'translate(0, 0)';
                touchId = null;
            });
            
            // Zoom buttons
            zoomInBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                camera.position.y = Math.max(10, camera.position.y - 3);
            });
            
            zoomOutBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                camera.position.y = Math.min(60, camera.position.y + 3);
            });
            
            // Floor buttons
            floorButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const floor = btn.dataset.floor;
                    goToFloor(floor);
                });
            });
            
            // Prevent default touch behaviors
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.joystick') || e.target.closest('.touch-btn') || e.target.closest('.floor-btn')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Move user based on joystick input
        function moveUser(x, z) {
            const speed = 0.4;
            const newX = userPosition.x + x * speed;
            const newZ = userPosition.z + z * speed;
            
            // Keep user within bounds
            if (newX > -30 && newX < 30 && newZ > -20 && newZ < 20) {
                updateUserPosition(newX, userPosition.y, newZ);
            }
        }

        // Change floor
        function goToFloor(floor) {
            if (floor === currentFloor) return;
            
            // Update floor buttons
            floorButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.floor === floor);
            });
            
            currentFloor = floor;
            userFloor = floor;
            
            // Move user to appropriate height
            let newY = 0;
            if (floor === "first") newY = 3.5;
            if (floor === "second") newY = 7;
            
            updateUserPosition(userPosition.x, newY, userPosition.z);
            
            // Show notification
            showToast("گۆڕینی نهۆم", `گواسترایتەوە بۆ ${floor === 'ground' ? 'نهۆمی سەرەتایی' : floor === 'first' ? 'نهۆمی یەکەم' : 'نهۆمی دووەم'}`);
        }

        // Handle window resize
        function onWindowResize() {
            const canvas = document.getElementById('3d-viewer');
            const container = canvas.parentElement;
            
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            // Update path indicators position
            updatePathIndicators();
        }

        // Update path indicators on resize
        function updatePathIndicators() {
            const viewer = document.getElementById('3d-viewer');
            const width = viewer.clientWidth;
            const height = viewer.clientHeight;
            
            // Clear existing indicators
            pathIndicators.innerHTML = '';
            
            // Recreate path indicators
            roomConnections.forEach(connection => {
                const fromRoom = rooms.find(r => r.id === connection.from);
                const toRoom = rooms.find(r => r.id === connection.to);
                
                if (!fromRoom || !toRoom) return;
                
                const pathIndicator = document.createElement('div');
                pathIndicator.className = 'path-line';
                pathIndicator.style.backgroundColor = `rgb(${(connection.color >> 16) & 255}, ${(connection.color >> 8) & 255}, ${connection.color & 255})`;
                
                const screenFromX = (fromRoom.x + 30) / 60 * width;
                const screenFromY = (fromRoom.z + 20) / 40 * height;
                const screenToX = (toRoom.x + 30) / 60 * width;
                const screenToY = (toRoom.z + 20) / 40 * height;
                
                const dx = screenToX - screenFromX;
                const dy = screenToY - screenFromY;
                const length = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                pathIndicator.style.width = `${length}px`;
                pathIndicator.style.height = '6px';
                pathIndicator.style.left = `${screenFromX}px`;
                pathIndicator.style.top = `${screenFromY - 3}px`;
                pathIndicator.style.transform = `rotate(${angle}deg)`;
                pathIndicator.style.transformOrigin = '0 0';
                
                pathIndicators.appendChild(pathIndicator);
                
                const arrow = document.createElement('div');
                arrow.className = 'path-arrow';
                arrow.style.borderTopColor = `rgb(${(connection.color >> 16) & 255}, ${(connection.color >> 8) & 255}, ${connection.color & 255})`;
                arrow.style.left = `${screenToX - 8}px`;
                arrow.style.top = `${screenToY - 6}px`;
                arrow.style.transform = `rotate(${angle}deg)`;
                
                pathIndicators.appendChild(arrow);
            });
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
            
            // Rotate room labels to face camera
            roomMeshes.forEach(mesh => {
                if (mesh.label) {
                    mesh.label.lookAt(camera.position);
                }
            });
            
            // Update direction indicator rotation
            if (window.directionIndicator && joystickActive) {
                const angle = Math.atan2(-joystickPosition.y, joystickPosition.x);
                window.directionIndicator.rotation.y = -angle;
            }
            
            // Gentle rotation of the entire scene for visual interest
            if (isAutoTour) {
                scene.rotation.y += 0.001;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Location permission buttons
            allowLocationBtn.addEventListener('click', async () => {
                try {
                    const position = await getLocation();
                    hasLocationPermission = true;
                    permissionModal.style.display = 'none';
                    
                    // Simulate starting from a random room based on "location"
                    const randomRoom = Math.floor(Math.random() * 8) + 2;
                    goToRoom(randomRoom);
                    
                    showToast("لۆکەیشن چالاک کرایەوە", "ئێستا شوێنی ڕاستەقینەت نیشان دەدرێت");
                } catch (error) {
                    showToast("کێشەی لۆکەیشن", "نەتوانرا لۆکەیشن بەدەست بێت");
                    permissionModal.style.display = 'none';
                    goToRoom(1);
                }
            });
            
            denyLocationBtn.addEventListener('click', () => {
                hasLocationPermission = false;
                permissionModal.style.display = 'none';
                goToRoom(1);
                showToast("سەردانی دەستی", "دەتوانیت بە دەستی خۆت بگەڕێیت");
            });
            
            // Navigation buttons
            prevRoomBtn.addEventListener('click', prevRoom);
            nextRoomBtn.addEventListener('click', nextRoom);
            autoTourBtn.addEventListener('click', toggleAutoTour);
            infoBtn.addEventListener('click', toggleRoomInfoPanel);
            closePanelBtn.addEventListener('click', toggleRoomInfoPanel);
            
            // Swipe gestures for mobile
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                // Only handle swipes on main area, not on controls
                if (e.target.closest('.mobile-controls') || 
                    e.target.closest('.touch-controls') || 
                    e.target.closest('.touch-buttons') ||
                    e.target.closest('.floor-indicator')) {
                    return;
                }
                
                touchStartX = e.changedTouches[0].clientX;
                touchStartY = e.changedTouches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                // Only handle swipes on main area
                if (e.target.closest('.mobile-controls') || 
                    e.target.closest('.touch-controls') || 
                    e.target.closest('.touch-buttons') ||
                    e.target.closest('.floor-indicator')) {
                    return;
                }
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // Swipe right (next room) - remember RTL direction
                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    if (diffX > 0) {
                        nextRoom();
                    } else {
                        prevRoom();
                    }
                }
                
                // Swipe up/down for floor change
                if (Math.abs(diffY) > 50 && Math.abs(diffY) > Math.abs(diffX)) {
                    if (diffY > 0) {
                        // Swipe down - go to lower floor
                        if (currentFloor === "second") goToFloor("first");
                        else if (currentFloor === "first") goToFloor("ground");
                    } else {
                        // Swipe up - go to higher floor
                        if (currentFloor === "ground") goToFloor("first");
                        else if (currentFloor === "first") goToFloor("second");
                    }
                }
                
                // Double tap to toggle info panel
                if (e.detail === 2) {
                    toggleRoomInfoPanel();
                }
            });
            
            // Close panel when clicking outside
            roomInfoPanel.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            });
            
            document.addEventListener('touchstart', (e) => {
                if (roomInfoPanel.classList.contains('open') && 
                    !e.target.closest('.room-info-panel') && 
                    !e.target.closest('#infoBtn')) {
                    toggleRoomInfoPanel();
                }
            });
            
            // Handle device orientation for movement
            if (window.DeviceOrientationEvent && hasLocationPermission) {
                window.addEventListener('deviceorientation', (e) => {
                    // Use tilt to move in the building
                    if (e.beta && e.gamma) {
                        const tiltX = (e.gamma || 0) / 45;
                        const tiltZ = (e.beta || 0 - 90) / 45;
                        
                        // Move user based on tilt (subtle movement)
                        moveUser(tiltX * 0.1, tiltZ * 0.1);
                    }
                });
            }
            
            // Keyboard controls for desktop testing
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowRight':
                    case 'd':
                        nextRoom();
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        prevRoom();
                        break;
                    case 'ArrowUp':
                    case 'w':
                        camera.position.y = Math.max(10, camera.position.y - 3);
                        break;
                    case 'ArrowDown':
                    case 's':
                        camera.position.y = Math.min(60, camera.position.y + 3);
                        break;
                    case ' ':
                        toggleAutoTour();
                        break;
                    case 'i':
                    case 'I':
                        toggleRoomInfoPanel();
                        break;
                    case '1':
                        goToFloor('ground');
                        break;
                    case '2':
                        goToFloor('first');
                        break;
                    case '3':
                        goToFloor('second');
                        break;
                }
            });
        }

        // Get user location
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation not supported"));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            });
        }

        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Prevent scrolling on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.room-info-panel')) {
                return; // Allow scrolling in info panel
            }
            e.preventDefault();
        }, { passive: false });

        // Handle back button to close panel
        document.addEventListener('backbutton', toggleRoomInfoPanel, false);
    </script>
</body>
</html>